{% extends "base.html" %}
{% block title %}Оборудование{% endblock %}

{% block content %}

<!-- ===== Header ===== -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="mb-0">Оборудование</h1>
    <div class="text-muted small">Список и состояние оборудования</div>
  </div>

  <div class="d-flex gap-2">
    <div class="btn-group">
      <button id="view-cards" type="button" class="btn btn-outline-secondary active">
        Карточки
      </button>
      <button id="view-table" type="button" class="btn btn-outline-secondary">
        Таблица
      </button>
    </div>

    <a class="btn btn-success" href="{% url 'assets:asset_new' %}">
      + Оборудование
    </a>
  </div>
</div>

<!-- ================= ФИЛЬТРЫ ================= -->
<form class="row g-2 mb-3" method="get">

  <div class="col-md-4">
    <input
      class="form-control"
      type="search"
      name="q"
      placeholder="Название, тип, модель"
      value="{{ request.GET.q }}"
    >
  </div>

  <div class="col-md-2">
    <select name="category" class="form-select">
      <option value="">Категория: все</option>
      {% for value,label in categories %}
        <option value="{{ value }}"
          {% if request.GET.category == value|stringformat:"s" %}selected{% endif %}
        >
          {{ label }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <select name="status" class="form-select">
      <option value="">Статус: все</option>
      {% for value,label in statuses %}
        <option value="{{ value }}"
          {% if request.GET.status == value|stringformat:"s" %}selected{% endif %}
        >
          {{ label }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <select name="location" class="form-select">
      <option value="">Локация: все</option>
      {% for loc in locations %}
        <option value="{{ loc.pk }}"
          {% if request.GET.location == loc.pk|stringformat:"s" %}selected{% endif %}
        >
          {{ loc.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2 d-flex gap-2">
    <button class="btn btn-primary w-100" type="submit">
      Фильтр
    </button>
    <a class="btn btn-outline-secondary w-100" href="{% url 'assets:asset_list' %}">
      Сброс
    </a>
  </div>

</form>

<!-- ================= ВИД 1: Карточки ================= -->
<div id="cards-view" class="row g-3">

  {% for x in object_list %}
    <div class="col-md-6 col-lg-4">
      <a
        class="card h-100 text-decoration-none shadow-sm border-0 hover-shadow"
        href="{% url 'assets:asset_detail' x.pk %}"
      >
        {% if x.photo %}
          <img
            src="{{ x.photo.url }}"
            class="card-img-top"
            style="object-fit:cover;height:180px"
            alt="{{ x.name }}"
          >
        {% endif %}

        <div class="card-body">
          <h5 class="card-title mb-1">{{ x.name }}</h5>

          <div class="text-muted small mb-1">
            {{ x.get_category_display }}
            {% if x.type_name %} • {{ x.type_name }}{% endif %}
          </div>

          <div class="small">
            {% if x.status == 'active' %}
              <span class="badge text-bg-success">Работает</span>
            {% elif x.status == 'repair' %}
              <span class="badge text-bg-warning">В ремонте</span>
            {% elif x.status == 'broken' %}
              <span class="badge text-bg-danger">Неисправно</span>
            {% else %}
              <span class="badge text-bg-secondary">
                {{ x.get_status_display }}
              </span>
            {% endif %}

            <span class="text-muted ms-2">{{ x.location }}</span>
          </div>
        </div>
      </a>
    </div>

  {% empty %}
    <div class="col-12">
      <div class="alert alert-secondary mb-0">
        Ничего не найдено
      </div>
    </div>
  {% endfor %}

</div>

<!-- ================= ВИД 2: Таблица ================= -->
<div id="table-view" class="table-responsive d-none">
  <table class="table table-hover align-middle">

    <thead class="table-light">
      <tr>
        <th style="width:56px;">Фото</th>
        <th>Название</th>
        <th>Категория</th>
        <th>Статус</th>
        <th>Локация</th>
      </tr>
    </thead>

    <tbody>
      {% for x in object_list %}
        <tr
          class="table-row-link"
          data-href="{% url 'assets:asset_detail' x.pk %}"
        >
          <td>
            {% if x.photo %}
              <img
                src="{{ x.photo.url }}"
                style="width:40px;height:40px;object-fit:cover;border-radius:6px;"
                alt=""
              >
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>

          <td class="fw-semibold">
            {{ x.name }}
            <div class="text-muted small">
              {{ x.type_name|default:"—" }}
            </div>
          </td>

          <td>{{ x.get_category_display }}</td>

          <td>
            {% if x.status == 'prod' %}
             <span class="badge text-bg-success">Работает</span>
            {% elif x.status == 'problem' %}
              <span class="badge text-bg-danger">Аварийный ремонт</span>
            {% elif x.status == 'maint' %}
             <span class="badge text-bg-warning">Техническое обслуживание</span>
            {% elif x.status == 'setup' %}
              <span class="badge text-bg-info">Пусконаладочные работы</span>
            {% else %}
             <span class="badge text-bg-secondary">
                {{ x.get_status_display }}
              </span>
            {% endif %}

          </td>

          <td>{{ x.location }}</td>
        </tr>

      {% empty %}
        <tr>
          <td colspan="6">
            <div class="alert alert-secondary mb-0">
              Ничего не найдено
            </div>
          </td>
        </tr>
      {% endfor %}
    </tbody>

  </table>
</div>

{% include "includes/pagination.html" %}

<!-- ================= JS ================= -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const KEY = 'assets_view_mode';
  const cardsBtn = document.getElementById('view-cards');
  const tableBtn = document.getElementById('view-table');
  const cardsView = document.getElementById('cards-view');
  const tableView = document.getElementById('table-view');

  function apply(mode) {
    const isTable = mode === 'table';
    cardsView.classList.toggle('d-none', isTable);
    tableView.classList.toggle('d-none', !isTable);
    tableBtn.classList.toggle('active', isTable);
    cardsBtn.classList.toggle('active', !isTable);
    try { localStorage.setItem(KEY, mode); } catch(e) {}
  }

  cardsBtn.addEventListener('click', () => apply('cards'));
  tableBtn.addEventListener('click', () => apply('table'));
  apply(localStorage.getItem(KEY) || 'cards');

  document.querySelectorAll('.table-row-link').forEach(row => {
    row.addEventListener('click', e => {
      if (e.target.closest('a,button')) return;
      window.location = row.dataset.href;
    });
  });
});
</script>

<style>
.table-row-link { cursor: pointer; }
.table-row-link:hover { background-color: rgba(0,0,0,.03); }

.hover-shadow:hover {
  box-shadow: 0 .5rem 1rem rgba(0,0,0,.08);
  transform: translateY(-1px);
}
</style>

{% endblock %}

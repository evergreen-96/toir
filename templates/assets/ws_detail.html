{% extends "base.html" %}
{% load static %}
{% block title %}{{ workstation.name }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-xl-10 col-lg-11">

        <div class="card shadow-sm border-0">
            <div class="card-body">

                <!-- =====================================================
                     HEADER
                     ===================================================== -->
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <h1 class="h4 mb-1">{{ workstation.name }}</h1>
                        <div class="text-muted small">
                            Оборудование · карточка
                            <span class="ms-3">
                                Создано: {{ workstation.created_at|date:"d.m.Y" }}
                            </span>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <a class="btn btn-outline-secondary"
                           href="{% url 'assets:asset_list' %}">
                            ← Назад
                        </a>

                        {% if perms.assets.change_workstation %}
                        <a class="btn btn-primary"
                           href="{% url 'assets:asset_edit' workstation.pk %}">
                            Редактировать
                        </a>
                        {% endif %}

                        {% if perms.assets.delete_workstation %}
                        <button class="btn btn-outline-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteModal">
                            Удалить
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- =====================================================
                     ОСНОВНЫЕ ХАРАКТЕРИСТИКИ
                     ===================================================== -->
                <div class="mb-4">
                    <div class="section-header">Основные характеристики</div>

                    <div class="detail-grid">

                        <div class="detail-item">
                            <div class="detail-label">Статус</div>
                            <div class="detail-value">
                                {% with s=workstation.status %}
                                    {% if s == "prod" %}
                                        <span class="badge bg-success status-badge">{{ workstation.get_status_display }}</span>
                                    {% elif s == "problem" %}
                                        <span class="badge bg-danger status-badge">{{ workstation.get_status_display }}</span>
                                    {% elif s == "maint" %}
                                        <span class="badge bg-warning text-dark status-badge">{{ workstation.get_status_display }}</span>
                                    {% elif s == "setup" %}
                                        <span class="badge bg-info status-badge">{{ workstation.get_status_display }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary status-badge">{{ workstation.get_status_display }}</span>
                                    {% endif %}
                                {% endwith %}
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-label">Категория</div>
                            <div class="detail-value">
                                {{ workstation.get_category_display }}
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-label">Производитель</div>
                            <div class="detail-value">
                                {{ workstation.manufacturer|default:"—" }}
                            </div>
                        </div>

                        <div class="detail-item">
                            <div class="detail-label">Серийный номер</div>
                            <div class="detail-value">
                                {{ workstation.serial_number|default:"—" }}
                            </div>
                        </div>

                    </div>
                </div>

                <!-- =====================================================
                     ФОТО
                     ===================================================== -->
                {% if workstation.photo %}
                <div class="mb-4">
                    <div class="section-header">Фотография</div>

                    <img src="{{ workstation.photo.url }}"
                         class="asset-photo-thumb"
                         data-bs-toggle="modal"
                         data-bs-target="#photoModal">
                </div>
                {% endif %}

            </div>

            <div class="card-footer text-muted small d-flex justify-content-between">
                <span>ID: {{ workstation.id }}</span>
                <span>Обновлено: {{ workstation.updated_at|date:"d.m.Y H:i" }}</span>
            </div>
        </div>
    </div>
</div>

<!-- =====================================================
     МОДАЛКА ФОТО
     ===================================================== -->
{% if workstation.photo %}
<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <img src="{{ workstation.photo.url }}" class="img-fluid rounded">
        </div>
    </div>
</div>
{% endif %}

<!-- =====================================================
     МОДАЛКА УДАЛЕНИЯ
     ===================================================== -->
{% if perms.assets.delete_workstation %}
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <form method="post"
              action="{% url 'assets:asset_delete' workstation.pk %}"
              class="modal-content">
            {% csrf_token %}
            <div class="modal-header">
                <h5 class="modal-title">Удаление оборудования</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Вы уверены, что хотите удалить <strong>{{ workstation.name }}</strong>?
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Отмена
                </button>
                <button class="btn btn-danger">
                    Удалить
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<!-- =====================================================
     STYLES
     ===================================================== -->
<style>
.section-header {
    font-weight: 600;
    border-bottom: 2px solid var(--bs-primary);
    margin-bottom: 1rem;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
}

.detail-label {
    font-size: .85rem;
    color: var(--bs-secondary);
}

.detail-value {
    font-weight: 500;
}

.asset-photo-thumb {
    max-width: 240px;
    cursor: zoom-in;
    border: 1px solid var(--bs-border-color);
    border-radius: .5rem;
}

.status-badge {
    cursor: pointer;
}
</style>

<!-- =====================================================
     SCRIPT
     ===================================================== -->
<script>
const CAN_CHANGE_STATUS = {{ perms.assets.change_workstation|yesno:"true,false" }};
const WORKSTATION_ID = {{ workstation.id }};

document.addEventListener('DOMContentLoaded', () => {
    const badge = document.querySelector('.status-badge');
    if (!badge || !CAN_CHANGE_STATUS) return;

    badge.title = 'Нажмите для изменения статуса';

    badge.addEventListener('click', () => {
        fetch(`{% url "assets:ajax_get_status" %}?id=${WORKSTATION_ID}`)
            .then(r => r.json())
            .then(data => {
                if (!data.ok) return;

                showStatusModal(data);
            });
    });
});

function showStatusModal(data) {
    const html = `
    <div class="modal fade" id="statusModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Изменение статуса</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <select class="form-select" id="newStatus">
              ${Object.entries(data.choices).map(
                ([v,l]) => `<option value="${v}" ${v===data.current?'selected':''}>${l}</option>`
              ).join('')}
            </select>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
            <button class="btn btn-primary" id="saveStatus">Сохранить</button>
          </div>
        </div>
      </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);
    const modalEl = document.getElementById('statusModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    document.getElementById('saveStatus').onclick = () => {
        fetch('{% url "assets:ajax_update_status" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `id=${WORKSTATION_ID}&status=${document.getElementById('newStatus').value}`
        })
        .then(r => r.json())
        .then(res => {
            if (res.ok) location.reload();
            else alert(res.error || 'Ошибка');
        });
    };

    modalEl.addEventListener('hidden.bs.modal', () => modalEl.remove());
}
</script>

{% endblock %}

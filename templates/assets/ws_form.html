{% extends "base.html" %}
{% load static form_extras %}

{% block title %}{% if create %}Новое оборудование{% else %}Редактирование оборудования{% endif %}{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- HEADER -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
        <div class="mb-3 mb-md-0">
            <nav aria-label="breadcrumb" class="mb-2">
                <ol class="breadcrumb small mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'assets:asset_list' %}" class="text-decoration-none">Оборудование</a></li>
                    {% if not create and object %}<li class="breadcrumb-item"><a href="{% url 'assets:asset_detail' object.pk %}" class="text-decoration-none">{{ object.name|truncatechars:20 }}</a></li>{% endif %}
                    <li class="breadcrumb-item active">{% if create %}Новое{% else %}Редактирование{% endif %}</li>
                </ol>
            </nav>
            <h1 class="h2 mb-1">
                {% if create %}<i class="bi bi-plus-circle me-2 text-success"></i>Новое оборудование
                {% else %}<i class="bi bi-pencil-square me-2 text-primary"></i>Редактирование{% endif %}
            </h1>
            <div class="text-muted small">
                {% if create %}Добавление нового оборудования в систему{% else %}ID: {{ object.pk }} · {{ object.updated_at|date:"d.m.Y H:i" }}{% endif %}
            </div>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="{% url 'assets:asset_list' %}"><i class="bi bi-arrow-left me-1"></i>Назад</a>
            {% if not create %}<a class="btn btn-outline-info" href="{% url 'assets:asset_detail' object.pk %}"><i class="bi bi-eye me-1"></i>Просмотр</a>{% endif %}
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="alert alert-danger mb-4"><i class="bi bi-exclamation-triangle me-2"></i>{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="row">
            <!-- ЛЕВАЯ КОЛОНКА -->
            <div class="col-lg-8">
                <!-- Основная информация -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-dark border-0">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2 text-primary"></i>Основная информация</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label fw-semibold" for="{{ form.name.id_for_label }}">{{ form.name.label }} <span class="text-danger">*</span></label>
                                {{ form.name|add_class:"form-control" }}
                                {% if form.name.errors %}<div class="invalid-feedback d-block">{{ form.name.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold" for="{{ form.category.id_for_label }}">{{ form.category.label }} <span class="text-danger">*</span></label>
                                {{ form.category|add_class:"form-select" }}
                                {% if form.category.errors %}<div class="invalid-feedback d-block">{{ form.category.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" for="{{ form.type_name.id_for_label }}">{{ form.type_name.label }}</label>
                                {{ form.type_name|add_class:"form-control" }}
                                {% if form.type_name.errors %}<div class="invalid-feedback d-block">{{ form.type_name.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" for="{{ form.manufacturer.id_for_label }}">{{ form.manufacturer.label }}</label>
                                {{ form.manufacturer|add_class:"form-control" }}
                                {% if form.manufacturer.errors %}<div class="invalid-feedback d-block">{{ form.manufacturer.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" for="{{ form.model.id_for_label }}">{{ form.model.label }}</label>
                                {{ form.model|add_class:"form-control" }}
                                {% if form.model.errors %}<div class="invalid-feedback d-block">{{ form.model.errors }}</div>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Идентификация -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-dark border-0">
                        <h5 class="mb-0"><i class="bi bi-upc-scan me-2 text-primary"></i>Идентификация</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" for="{{ form.serial_number.id_for_label }}">{{ form.serial_number.label }}</label>
                                {{ form.serial_number|add_class:"form-control font-monospace" }}
                                {% if form.serial_number.errors %}<div class="invalid-feedback d-block">{{ form.serial_number.errors }}</div>{% endif %}
                                <div class="form-text small">{{ form.serial_number.help_text }}</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" for="{{ form.inventory_number.id_for_label }}">{{ form.inventory_number.label }}</label>
                                {{ form.inventory_number|add_class:"form-control font-monospace" }}
                                {% if form.inventory_number.errors %}<div class="invalid-feedback d-block">{{ form.inventory_number.errors }}</div>{% endif %}
                                <div class="form-text small">{{ form.inventory_number.help_text }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Состояние и расположение -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-dark border-0">
                        <h5 class="mb-0"><i class="bi bi-gear me-2 text-primary"></i>Состояние и расположение</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" for="{{ form.status.id_for_label }}">{{ form.status.label }} <span class="text-danger">*</span></label>
                                {{ form.status|add_class:"form-select" }}
                                {% if form.status.errors %}<div class="invalid-feedback d-block">{{ form.status.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" for="{{ form.global_state.id_for_label }}">{{ form.global_state.label }} <span class="text-danger">*</span></label>
                                {{ form.global_state|add_class:"form-select" }}
                                {% if form.global_state.errors %}<div class="invalid-feedback d-block">{{ form.global_state.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" for="{{ form.location.id_for_label }}">{{ form.location.label }} <span class="text-danger">*</span></label>
                                {{ form.location|add_class:"form-select" }}
                                {% if form.location.errors %}<div class="invalid-feedback d-block">{{ form.location.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" for="{{ form.responsible.id_for_label }}">{{ form.responsible.label }}</label>
                                {{ form.responsible|add_class:"form-select" }}
                                {% if form.responsible.errors %}<div class="invalid-feedback d-block">{{ form.responsible.errors }}</div>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Эксплуатация -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-dark border-0">
                        <h5 class="mb-0"><i class="bi bi-calendar-check me-2 text-primary"></i>Эксплуатация</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" for="{{ form.commissioning_date.id_for_label }}">{{ form.commissioning_date.label }}</label>
                                {{ form.commissioning_date|add_class:"form-control" }}
                                {% if form.commissioning_date.errors %}<div class="invalid-feedback d-block">{{ form.commissioning_date.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold" for="{{ form.warranty_until.id_for_label }}">{{ form.warranty_until.label }}</label>
                                {{ form.warranty_until|add_class:"form-control" }}
                                {% if form.warranty_until.errors %}<div class="invalid-feedback d-block">{{ form.warranty_until.errors }}</div>{% endif %}
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-semibold" for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                                {{ form.description|add_class:"form-control" }}
                                {% if form.description.errors %}<div class="invalid-feedback d-block">{{ form.description.errors }}</div>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ПРАВАЯ КОЛОНКА -->
            <div class="col-lg-4">
                <div class="sticky-top" style="top: 20px;">
                    <!-- Фото -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-dark border-0">
                            <h5 class="mb-0"><i class="bi bi-image me-2 text-primary"></i>Фотография</h5>
                        </div>
                        <div class="card-body">
                            {% if not create and object.photo %}
                            <div class="mb-3 text-center">
                                <img src="{{ object.photo.url }}" class="img-fluid rounded mb-2" style="max-height: 200px;" alt="Текущее фото">
                                <div class="text-muted small">Текущее фото</div>
                            </div>
                            {% endif %}
                            <label class="form-label fw-semibold" for="{{ form.photo.id_for_label }}">{% if not create and object.photo %}Заменить фото{% else %}Загрузить фото{% endif %}</label>
                            {{ form.photo|add_class:"form-control" }}
                            {% if form.photo.errors %}<div class="invalid-feedback d-block">{{ form.photo.errors }}</div>{% endif %}
                            <div class="form-text small">{{ form.photo.help_text }}</div>
                        </div>
                    </div>

                    <!-- Кнопки -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-check-lg me-2"></i>{% if create %}Создать{% else %}Сохранить{% endif %}
                                </button>
                                <a href="{% if create %}{% url 'assets:asset_list' %}{% else %}{% url 'assets:asset_detail' object.pk %}{% endif %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-lg me-2"></i>Отмена
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

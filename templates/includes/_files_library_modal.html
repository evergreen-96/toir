<div class="modal fade" id="filesLibraryModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ñ–∞–π–ª–æ–≤</h5>
                <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                ></button>
            </div>

            <div class="modal-body">

                <input
                        type="search"
                        class="form-control mb-3"
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞‚Ä¶"
                        id="fileSearch"
                />

                <div class="list-group">
                    {% for f in all_files %}
                    <label class="list-group-item d-flex align-items-center gap-2">
                        <input
                                class="form-check-input"
                                type="checkbox"
                                name="existing_files"
                                value="{{ f.id }}"
                                form="wo-form"
                                data-file-name="{{ f.file.name|cut:'workorders/' }}"
                                data-file-url="{{ f.file.url }}"
                        >

                        <!-- preview -->
                        <div class="file-preview flex-shrink-0"></div>

                        <span class="text-truncate flex-grow-1">
        {{ f.file.name|cut:"workorders/" }}
    </span>
                    </label>
                    {% empty %}
                    <div class="text-muted small">
                        –§–∞–π–ª–æ–≤ –Ω–µ—Ç
                    </div>
                    {% endfor %}
                </div>

            </div>

            <div class="modal-footer">
                <button
                        type="button"
                        class="btn btn-primary"
                        data-bs-dismiss="modal"
                >
                    –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>

        </div>
    </div>
    <div class="modal fade" id="imagePreviewModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content bg-transparent border-0">

                <div class="modal-body p-0 text-center">
                    <img
                            id="imagePreviewModalImg"
                            src=""
                            class="img-fluid rounded shadow"
                            style="max-height: 90vh;"
                    >
                </div>

                <button
                        type="button"
                        class="btn-close position-absolute top-0 end-0 m-3"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                ></button>

            </div>
        </div>
    </div>
</div>
<style>
    .file-preview {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .file-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const imageModalEl = document.getElementById("imagePreviewModal");
    const imageModalImg = document.getElementById("imagePreviewModalImg");
    const imageModal = imageModalEl
        ? new bootstrap.Modal(imageModalEl)
        : null;

    document
        .querySelectorAll('#filesLibraryModal input[type="checkbox"]')
        .forEach(cb => {

            const label = cb.closest("label");
            const preview = label.querySelector(".file-preview");
            const url = cb.dataset.fileUrl;

            if (!preview || !url) return;

            const isImage = /\.(jpg|jpeg|png|gif|webp|svg)$/i.test(url);

            if (isImage) {
                const img = document.createElement("img");
                img.src = url;
                img.loading = "lazy";
                img.style.cursor = "zoom-in";

                // üîç –ö–õ–ò–ö ‚Üí –û–¢–ö–†–´–¢–¨ –í –ë–û–õ–¨–®–û–ú –í–ò–î–ï
                img.addEventListener("click", function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    if (!imageModal) return;

                    imageModalImg.src = url;
                    imageModal.show();
                });

                preview.appendChild(img);
            } else {
                preview.innerHTML = `
                    <i class="bi bi-file-earmark text-muted fs-4"></i>
                `;
            }
        });

});
</script>
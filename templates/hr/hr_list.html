{% extends "base.html" %}
{% block title %}Персонал{% endblock %}

{% block content %}

<!-- ===== Header ===== -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-0">Персонал</h1>
        <div class="text-muted small">Сотрудники и орг-структура</div>
    </div>
    <a class="btn btn-success" href="{% url 'hr:hr_new' %}">
        + Сотрудник
    </a>
</div>

<!-- ================= ФИЛЬТРЫ ================= -->
<form method="get" class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">

            <!-- Руководитель -->
            <div class="col-md-4">
                <label class="form-label fw-semibold">Руководитель</label>
                <select
                        name="manager"
                        id="filter-manager"
                        class="form-select"
                        data-placeholder="Все руководители"
                >
                    {% if current_manager_obj %}
                        <option value="{{ current_manager_obj.pk }}" selected>
                            {{ current_manager_obj.name }}
                            {% if current_manager_obj.job_title %}
                                — {{ current_manager_obj.job_title }}
                            {% endif %}
                        </option>
                    {% endif %}
                </select>
            </div>

            <!-- Должность -->
            <div class="col-md-4">
                <label class="form-label fw-semibold">Должность</label>
                <select
                        name="job_title"
                        id="filter-job-title"
                        class="form-select"
                        data-placeholder="Все должности"
                >
                    {% if current_job_title %}
                        <option value="{{ current_job_title }}" selected>
                            {{ current_job_title }}
                        </option>
                    {% endif %}
                </select>
            </div>

            <!-- Только руководители -->
            <div class="col-md-2">
                <div class="form-check mt-4">
                    <input
                            class="form-check-input"
                            type="checkbox"
                            name="only_managers"
                            id="only-managers"
                            value="1"
                            {% if only_managers %}checked{% endif %}
                    >
                    <label class="form-check-label fw-semibold" for="only-managers">
                        Только руководители
                    </label>
                </div>
            </div>

            <!-- Кнопки -->
            <div class="col-md-2 d-flex gap-2">
                <button class="btn btn-primary w-100" type="submit">
                    Применить
                </button>
                <a class="btn btn-outline-secondary w-100" href="{% url 'hr:hr_list' %}">
                    Сброс
                </a>
            </div>

        </div>
    </div>
</form>

<!-- ================= ТАБЛИЦА ================= -->
<div class="card shadow-sm border-0">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
            <tr>
                <th>ФИО</th>
                <th>Должность</th>
                <th>Руководитель</th>
                <th class="text-center">Подчинённые</th>
            </tr>
            </thead>
            <tbody>

            {% for x in object_list %}
                <tr class="table-row-link" data-href="{% url 'hr:hr_detail' x.pk %}">
                    <td>
                        <a href="{% url 'hr:hr_detail' x.pk %}"
                           class="fw-semibold text-decoration-none">
                            {{ x.name }}
                        </a>
                    </td>

                    <td class="text-muted">
                        {{ x.job_title|default:"—" }}
                    </td>

                    <td>
                        {% if x.manager %}
                            <a href="{% url 'hr:hr_detail' x.manager.pk %}"
                               class="text-decoration-none">
                                {{ x.manager.name }}
                            </a>
                        {% else %}
                            —
                        {% endif %}
                    </td>

                    <td class="text-center">
                        {% if x.subordinates_count %}
                            <span class="badge bg-primary rounded-pill">
                                {{ x.subordinates_count }}
                            </span>
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4" class="text-center text-muted py-4">
                        Ничего не найдено
                    </td>
                </tr>
            {% endfor %}

            </tbody>
        </table>
    </div>
</div>

<!-- ================= LIBS ================= -->


<!-- ================= JS ================= -->
<script>
$(document).ready(function () {

    $('#filter-manager').select2({
        width: '100%',
        allowClear: true,
        placeholder: 'Все руководители',
        ajax: {
            url: "{% url 'hr:hr_manager_autocomplete' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return { q: params.term };
            },
            processResults: function (data) {
                return { results: data.results };
            }
        }
    });

    $('#filter-job-title').select2({
        width: '100%',
        allowClear: true,
        placeholder: 'Все должности',
        ajax: {
            url: "{% url 'hr:hr_job_title_autocomplete' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return { q: params.term };
            },
            processResults: function (data) {
                return { results: data.results };
            }
        }
    });

    $('.table-row-link').on('click', function (e) {
        if ($(e.target).closest('a, button, input, label, select').length) {
            return;
        }
        window.location.href = $(this).data('href');
    });

});
</script>

<style>
.table-row-link {
    cursor: pointer;
}
.table-row-link:hover {
    background-color: rgba(0, 0, 0, 0.04);
}
.table-row-link a {
    position: relative;
    z-index: 2;
}
</style>

{% endblock %}

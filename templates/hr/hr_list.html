{% extends "base.html" %}
{% block title %}Персонал{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="mb-0">Персонал</h1>
  <a class="btn btn-success" href="{% url 'hr:hr_new' %}">
    + Сотрудник
  </a>
</div>

<!-- ================= ФИЛЬТРЫ ================= -->
<form method="get" class="card card-body mb-4">
  <div class="row g-3 align-items-end">

    <!-- Руководитель -->
    <div class="col-md-4">
      <label class="form-label">Руководитель</label>
      <select
        name="manager"
        id="filter-manager"
        class="form-select"
        data-placeholder="Все руководители"
      >
        {% if current_manager %}
          <option value="{{ current_manager }}" selected>
            {{ current_manager }}
          </option>
        {% endif %}
      </select>
    </div>

    <!-- Должность -->
    <div class="col-md-4">
      <label class="form-label">Должность</label>
      <input
        type="text"
        name="job_title"
        class="form-control"
        placeholder="Например: Инженер"
        value="{{ current_job_title }}"
      >
    </div>

    <!-- Только руководители -->
    <div class="col-md-2">
      <div class="form-check mt-4">
        <input
          class="form-check-input"
          type="checkbox"
          name="only_managers"
          id="only-managers"
          value="1"
          {% if only_managers %}checked{% endif %}
        >
        <label class="form-check-label" for="only-managers">
          Только руководители
        </label>
      </div>
    </div>

    <!-- Кнопки -->
    <div class="col-md-2 d-flex gap-2">
      <button class="btn btn-primary w-100" type="submit">
        Применить
      </button>
      <a class="btn btn-outline-secondary w-100" href="{% url 'hr:hr_list' %}">
        Сброс
      </a>
    </div>

  </div>
</form>

<!-- ================= ТАБЛИЦА ================= -->
<div class="table-responsive">
  <table class="table table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>ФИО</th>
        <th>Должность</th>
        <th>Руководитель</th>
        <th class="text-center">Подчинённые</th>
      </tr>
    </thead>
    <tbody>

      {% for x in object_list %}
        <tr>
          <td>
            <a href="{% url 'hr:hr_detail' x.pk %}">
              {{ x.name }}
            </a>
          </td>

          <td>
            {{ x.job_title|default:"—" }}
          </td>

          <td>
            {% if x.manager %}
              <a href="{% url 'hr:hr_detail' x.manager.pk %}">
                {{ x.manager.name }}
              </a>
            {% else %}
              —
            {% endif %}
          </td>

          <td class="text-center">
            {% if x.subordinates_count %}
              <span class="badge bg-primary">
                {{ x.subordinates_count }}
              </span>
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="4" class="text-center text-muted py-4">
            Ничего не найдено
          </td>
        </tr>
      {% endfor %}

    </tbody>
  </table>
</div>

<!-- ================= SELECT2 ================= -->
<script>
$(document).ready(function () {
  $('#filter-manager').select2({
    width: '100%',
    allowClear: true,
    placeholder: $(this).data('placeholder'),
    ajax: {
      url: "{% url 'hr:hr_manager_autocomplete' %}",
      dataType: 'json',
      delay: 250,
      data: function (params) {
        return {
          q: params.term
        };
      },
      processResults: function (data) {
        return data;
      }
    }
  });
});
</script>

{% endblock %}

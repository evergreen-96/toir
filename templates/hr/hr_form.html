{% extends "base.html" %}
{% load static form_extras %}
{% block title %}
  {% if create %}–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞{% endif %}
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-xl-8 col-lg-9">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <!-- =====================================================
             1. HEADER
             ===================================================== -->
        <div class="mb-3">
          <h1 class="h4 mb-1">
            {% if create %}
            <i class="fas fa-user-plus me-2 text-success"></i>
            –ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫
            {% else %}
            <i class="fas fa-user-edit me-2 text-primary"></i>
            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            {% endif %}
          </h1>
          <div class="text-muted small">
            {% if create %}
            –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ —Å–∏—Å—Ç–µ–º—É
            {% else %}
            –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –ø–æ–¥—á–∏–Ω—ë–Ω–Ω–æ—Å—Ç—å
            {% endif %}
          </div>
        </div>

        <form method="post" novalidate id="hrForm">
          {% csrf_token %}

          {% if form.non_field_errors %}
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            {{ form.non_field_errors }}
          </div>
          {% endif %}

          <!-- =====================================================
               2. –û–°–ù–û–í–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø
               ===================================================== -->
          <div class="mb-4">
            <div class="section-header">
              <i class="fas fa-id-card me-2"></i>
              –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            </div>

            <div class="row g-3">
              <!-- –§–ò–û -->
              <div class="col-md-8">
                <label class="form-label fw-semibold">
                  <i class="fas fa-user me-1"></i>
                  {{ form.name.label }}
                  <span class="text-danger">*</span>
                </label>
                {{ form.name|add_class:"form-control" }}
                {% if form.name.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.name.errors }}
                </div>
                {% endif %}
                <div class="form-text">–ü–æ–ª–Ω–æ–µ –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</div>
              </div>

              <!-- –°—Ç–∞—Ç—É—Å -->
              <div class="col-md-4">
                <label class="form-label fw-semibold">
                  <i class="fas fa-power-off me-1"></i>
                  {{ form.is_active.label }}
                </label>
                <div class="form-check form-switch mt-2">
                  {{ form.is_active|add_class:"form-check-input" }}
                  <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                    –ê–∫—Ç–∏–≤–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫
                  </label>
                </div>
                {% if form.is_active.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.is_active.errors }}
                </div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- =====================================================
               3. –î–û–õ–ñ–ù–û–°–¢–¨
               ===================================================== -->
          <div class="mb-4">
            <div class="section-header">
              <i class="fas fa-briefcase me-2"></i>
              –î–æ–ª–∂–Ω–æ—Å—Ç—å
            </div>

            <div class="row g-3">
              <div class="col-md-12">
                <label class="form-label fw-semibold">
                  <i class="fas fa-user-tag me-1"></i>
                  {{ form.job_title.label }}
                </label>
                {{ form.job_title|add_class:"form-select js-job-title" }}
                {% if form.job_title.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.job_title.errors }}
                </div>
                {% endif %}
                <div class="form-text">–í–≤–µ–¥–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞</div>

              </div>
            </div>
          </div>

          <!-- =====================================================
               4. –ü–û–î–ß–ò–ù–Å–ù–ù–û–°–¢–¨
               ===================================================== -->
          <div class="mb-4">
            <div class="section-header">
              <i class="fas fa-sitemap me-2"></i>
              –ü–æ–¥—á–∏–Ω—ë–Ω–Ω–æ—Å—Ç—å
            </div>

            <div class="row g-3">
              <div class="col-md-12">
                <label class="form-label fw-semibold">
                  <i class="fas fa-user-tie me-1"></i>
                  {{ form.manager.label }}
                </label>
                {{ form.manager|add_class:"form-select js-manager-select" }}
                {% if form.manager.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.manager.errors }}
                </div>
                {% endif %}
                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
              </div>
            </div>
          </div>

          <!-- =====================================================
               5. ACTIONS
               ===================================================== -->
          <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
            <div>
              <a class="btn btn-outline-secondary" href="{% url 'hr:hr_list' %}">
                <i class="fas fa-times me-1"></i>
                –û—Ç–º–µ–Ω–∞
              </a>
              {% if not create %}
              <a class="btn btn-outline-info ms-2" href="{% url 'hr:hr_detail' object.pk %}">
                <i class="fas fa-eye me-1"></i>
                –ü—Ä–æ—Å–º–æ—Ç—Ä
              </a>
              {% endif %}
            </div>

            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary" type="button" id="saveAndAddAnother">
                <i class="fas fa-plus me-1"></i>
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å
              </button>
              <button class="btn btn-primary px-4" type="submit" id="saveBtn">
                <i class="fas fa-save me-1"></i>
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
              </button>
            </div>
          </div>

        </form>

      </div>
    </div>
  </div>
</div>

<!-- =====================================================
     JS
     ===================================================== -->
<script src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
<script src="{% static 'admin/js/vendor/select2/select2.full.js' %}"></script>

<script>
$(document).ready(function () {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Select2 –¥–ª—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è
    $('.js-manager-select').select2({
        width: '100%',
        placeholder: '–í—ã–±–µ—Ä–∏—Ç–µ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è',
        allowClear: true,
        theme: 'bootstrap-5',
        ajax: {
            url: "{% url 'hr:hr_manager_autocomplete' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return { q: params.term };
            },
            processResults: function (data) {
                return { results: data.results };
            }
        }
    });

    // –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
    const $job = $('.js-job-title');

if ($job.length) {
    $job.select2({
        width: '100%',
        tags: true,
        placeholder: '–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å',
        allowClear: true,
        theme: 'bootstrap-5',
        ajax: {
            url: "{% url 'hr:hr_job_title_autocomplete' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return { q: params.term };
            },
            processResults: function (data) {
                return { results: data.results };
            }
        },
        createTag: function (params) {
            const term = $.trim(params.term);
            if (!term) return null;
            return { id: term, text: term };
        }
    });

    // üîë –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    const initial = "{{ form.instance.job_title|default_if_none:''|escapejs }}";
    if (initial) {
        const opt = new Option(initial, initial, true, true);
        $job.append(opt).trigger('change');
    }
}

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
    function validateRequiredFields() {
        let isValid = true;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏
        const nameField = $('#id_name');
        if (!nameField.val()) {
            nameField.addClass('is-invalid');
            isValid = false;
        } else {
            nameField.removeClass('is-invalid');
        }

        return isValid;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫ (—Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤–æ–∏–º —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º)
    function checkCircularReference() {
        const employeeId = {% if object %}{{ object.pk }}{% else %}null{% endif %};
        const managerId = $('.js-manager-select').val();

        if (employeeId && managerId && employeeId.toString() === managerId.toString()) {
            alert('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤–æ–∏–º —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º!');
            return false;
        }

        return true;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    $('#hrForm').on('submit', function(e) {
        if (!validateRequiredFields() || !checkCircularReference()) {
            e.preventDefault();
            return false;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        $('#saveBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
    });

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ
    $('#saveAndAddAnother').click(function() {
        if (validateRequiredFields() && checkCircularReference()) {
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
            $('<input>').attr({
                type: 'hidden',
                name: 'save_and_add',
                value: '1'
            }).appendTo('#hrForm');

            $('#hrForm').submit();
        }
    });

    // –£–ª—É—á—à–µ–Ω–∏–µ UX –¥–ª—è –ø–æ–ª–µ–π —Å –æ—à–∏–±–∫–∞–º–∏
    $('.is-invalid').each(function() {
        $(this).addClass('is-invalid');
    });

    // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ —Å –æ—à–∏–±–∫–æ–π
    const firstError = $('.is-invalid').first();
    if (firstError.length) {
        firstError.focus();
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—à–∏–±–æ–∫
    $('input, select').on('input change', function() {
        $(this).removeClass('is-invalid');
    });
});
</script>

<style>
.section-header {
    font-size: 1rem;
    font-weight: 600;
    color: var(--bs-heading-color);
    border-bottom: 2px solid var(--bs-primary);
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}

.select2-container--bootstrap-5 {
    width: 100% !important;
}

.form-text {
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

.invalid-feedback {
    display: block !important;
}

.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}

.form-switch .form-check-input {
    width: 3em;
    height: 1.5em;
}

.form-check-input:checked {
    background-color: var(--bs-success);
    border-color: var(--bs-success);
}

/* ================================
   HARD FIX: Select2 single alignment
   ================================ */

.select2-container--default
.select2-selection--single {
    display: flex;
    align-items: center;
}

/* –ö–õ–Æ–ß–ï–í–û–ô –§–ò–ö–° */
.select2-container--default
.select2-selection--single
.select2-selection__rendered {
    display: flex !important;
    align-items: center !important;

    height: 100% !important;
    line-height: normal !important;

    padding: 0 !important;
    margin: 0 !important;

    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* =========================================
   Select2 SINGLE ‚Äî HARD ABSOLUTE ALIGN FIX
   ========================================= */

.select2-container--default
.select2-selection--single {
    position: relative;
    height: calc(2.375rem + 2px);
}

/* üî• –∫–ª—é—á: –≤—ã—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ baseline */
.select2-container--default
.select2-selection--single
.select2-selection__rendered {
    position: absolute;
    left: .75rem;
    right: 2.25rem; /* –º–µ—Å—Ç–æ –ø–æ–¥ —Å—Ç—Ä–µ–ª–∫—É */

    top: 50%;
    transform: translateY(-50%);

    margin: 0 !important;
    padding: 0 !important;

    line-height: normal !important;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* clear (√ó) */
.select2-container--default
.select2-selection--single
.select2-selection__clear {
    position: absolute;
    right: 2rem;
    top: 50%;
    transform: translateY(-50%);
}

</style>
{% endblock %}
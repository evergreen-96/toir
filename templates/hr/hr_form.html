{% extends "base.html" %}
{% load static form_extras %}
{% block title %}
  {% if create %}Новый сотрудник{% else %}Редактирование сотрудника{% endif %}
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-xl-8 col-lg-9">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <!-- =====================================================
             1. HEADER
             ===================================================== -->
        <div class="mb-3">
          <h1 class="h4 mb-1">
            {% if create %}
            <i class="fas fa-user-plus me-2 text-success"></i>
            Новый сотрудник
            {% else %}
            <i class="fas fa-user-edit me-2 text-primary"></i>
            Редактирование сотрудника
            {% endif %}
          </h1>
          <div class="text-muted small">
            {% if create %}
            Добавление нового сотрудника в систему
            {% else %}
            Основная информация и подчинённость
            {% endif %}
          </div>
        </div>

        <div class="alert alert-info d-flex align-items-center mb-4">
          <i class="fas fa-info-circle fa-2x me-3"></i>
          <div>
            <strong>Внимание!</strong>
            Поля, отмеченные <span class="text-danger fw-semibold">*</span>, обязательны для заполнения.
            {% if not create %}
            <br>
            <small>Последнее изменение: {{ object.updated_at|date:"d.m.Y H:i" }}</small>
            {% endif %}
          </div>
        </div>

        <form method="post" novalidate id="hrForm">
          {% csrf_token %}

          {% if form.non_field_errors %}
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            {{ form.non_field_errors }}
          </div>
          {% endif %}

          <!-- =====================================================
               2. ОСНОВНАЯ ИНФОРМАЦИЯ
               ===================================================== -->
          <div class="mb-4">
            <div class="section-header">
              <i class="fas fa-id-card me-2"></i>
              Основная информация
            </div>

            <div class="row g-3">
              <!-- ФИО -->
              <div class="col-md-8">
                <label class="form-label fw-semibold">
                  <i class="fas fa-user me-1"></i>
                  {{ form.name.label }}
                  <span class="text-danger">*</span>
                </label>
                {{ form.name|add_class:"form-control" }}
                {% if form.name.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.name.errors }}
                </div>
                {% endif %}
                <div class="form-text">Полное имя сотрудника</div>
              </div>

              <!-- Статус -->
              <div class="col-md-4">
                <label class="form-label fw-semibold">
                  <i class="fas fa-power-off me-1"></i>
                  {{ form.is_active.label }}
                </label>
                <div class="form-check form-switch mt-2">
                  {{ form.is_active|add_class:"form-check-input" }}
                  <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                    Активный сотрудник
                  </label>
                </div>
                {% if form.is_active.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.is_active.errors }}
                </div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- =====================================================
               3. ДОЛЖНОСТЬ
               ===================================================== -->
          <div class="mb-4">
            <div class="section-header">
              <i class="fas fa-briefcase me-2"></i>
              Должность
            </div>

            <div class="row g-3">
              <div class="col-md-12">
                <label class="form-label fw-semibold">
                  <i class="fas fa-user-tag me-1"></i>
                  {{ form.job_title.label }}
                </label>
                {{ form.job_title|add_class:"form-control" }}
                {% if form.job_title.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.job_title.errors }}
                </div>
                {% endif %}
                <div class="form-text">Введите должность или выберите из списка</div>

                <!-- Datalist для подсказок должностей -->
                <datalist id="job-titles-datalist">
                  {% for title in job_titles %}
                    <option value="{{ title }}">
                  {% endfor %}
                </datalist>
              </div>
            </div>
          </div>

          <!-- =====================================================
               4. ПОДЧИНЁННОСТЬ
               ===================================================== -->
          <div class="mb-4">
            <div class="section-header">
              <i class="fas fa-sitemap me-2"></i>
              Подчинённость
            </div>

            <div class="row g-3">
              <div class="col-md-12">
                <label class="form-label fw-semibold">
                  <i class="fas fa-user-tie me-1"></i>
                  {{ form.manager.label }}
                </label>
                {{ form.manager|add_class:"form-select js-manager-select" }}
                {% if form.manager.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.manager.errors }}
                </div>
                {% endif %}
                <div class="form-text">Выберите руководителя из списка сотрудников</div>
              </div>
            </div>
          </div>

          <!-- =====================================================
               5. ACTIONS
               ===================================================== -->
          <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
            <div>
              <a class="btn btn-outline-secondary" href="{% url 'hr:hr_list' %}">
                <i class="fas fa-times me-1"></i>
                Отмена
              </a>
              {% if not create %}
              <a class="btn btn-outline-info ms-2" href="{% url 'hr:hr_detail' object.pk %}">
                <i class="fas fa-eye me-1"></i>
                Просмотр
              </a>
              {% endif %}
            </div>

            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary" type="button" id="saveAndAddAnother">
                <i class="fas fa-plus me-1"></i>
                Сохранить и добавить
              </button>
              <button class="btn btn-primary px-4" type="submit" id="saveBtn">
                <i class="fas fa-save me-1"></i>
                Сохранить
              </button>
            </div>
          </div>

        </form>

      </div>
    </div>
  </div>
</div>

<!-- =====================================================
     JS
     ===================================================== -->
<script src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
<script src="{% static 'admin/js/vendor/select2/select2.full.js' %}"></script>
<script>
$(document).ready(function () {
    // Инициализация Select2 для руководителя
    $('.js-manager-select').select2({
        width: '100%',
        placeholder: 'Выберите руководителя',
        allowClear: true,
        theme: 'bootstrap-5',
        ajax: {
            url: "{% url 'hr:hr_manager_autocomplete' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return { q: params.term };
            },
            processResults: function (data) {
                return { results: data.results };
            }
        }
    });

    // Автодополнение для должности
    const jobTitleInput = $('#id_job_title');
    if (jobTitleInput.length) {
        jobTitleInput.attr('list', 'job-titles-datalist');

        // Инициализация Select2 для должности с тегами
        jobTitleInput.select2({
            width: '100%',
            tags: true,
            placeholder: 'Введите или выберите должность',
            allowClear: true,
            theme: 'bootstrap-5',
            ajax: {
                url: "{% url 'hr:hr_job_title_autocomplete' %}",
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return { q: params.term };
                },
                processResults: function (data) {
                    return { results: data.results };
                }
            },
            createTag: function (params) {
                const term = $.trim(params.term);
                if (!term) return null;
                return {
                    id: term,
                    text: term
                };
            }
        });
    }

    // Проверка обязательных полей
    function validateRequiredFields() {
        let isValid = true;

        // Проверка имени
        const nameField = $('#id_name');
        if (!nameField.val()) {
            nameField.addClass('is-invalid');
            isValid = false;
        } else {
            nameField.removeClass('is-invalid');
        }

        return isValid;
    }

    // Проверка циклических ссылок (сотрудник не может быть своим руководителем)
    function checkCircularReference() {
        const employeeId = {% if object %}{{ object.pk }}{% else %}null{% endif %};
        const managerId = $('.js-manager-select').val();

        if (employeeId && managerId && employeeId.toString() === managerId.toString()) {
            alert('Сотрудник не может быть своим руководителем!');
            return false;
        }

        return true;
    }

    // Обработка отправки формы
    $('#hrForm').on('submit', function(e) {
        if (!validateRequiredFields() || !checkCircularReference()) {
            e.preventDefault();
            return false;
        }

        // Показываем индикатор загрузки
        $('#saveBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Сохранение...');
    });

    // Сохранить и добавить еще
    $('#saveAndAddAnother').click(function() {
        if (validateRequiredFields() && checkCircularReference()) {
            // Добавляем скрытое поле для редиректа
            $('<input>').attr({
                type: 'hidden',
                name: 'save_and_add',
                value: '1'
            }).appendTo('#hrForm');

            $('#hrForm').submit();
        }
    });

    // Улучшение UX для полей с ошибками
    $('.is-invalid').each(function() {
        $(this).addClass('is-invalid');
    });

    // Фокус на первое поле с ошибкой
    const firstError = $('.is-invalid').first();
    if (firstError.length) {
        firstError.focus();
    }

    // Автоматическое скрытие предупреждения при исправлении ошибок
    $('input, select').on('input change', function() {
        $(this).removeClass('is-invalid');
    });
});
</script>

<style>
.section-header {
    font-size: 1rem;
    font-weight: 600;
    color: var(--bs-heading-color);
    border-bottom: 2px solid var(--bs-primary);
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}

.select2-container--bootstrap-5 {
    width: 100% !important;
}

.form-text {
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

.invalid-feedback {
    display: block !important;
}

.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}

.form-switch .form-check-input {
    width: 3em;
    height: 1.5em;
}

.form-check-input:checked {
    background-color: var(--bs-success);
    border-color: var(--bs-success);
}
</style>
{% endblock %}
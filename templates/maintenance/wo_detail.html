{% extends "base.html" %}

{% block title %}{{ object.name }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-xl-8 col-lg-9">

        <div class="card shadow-sm border-0">
            <div class="card-body">

                <!-- =====================================================
                     Header + actions + STATUS BADGE
                     ===================================================== -->
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <h1 class="h4 mb-1 d-flex align-items-center gap-2">
                            {{ object.name }}

                            {# ===== Status badge ===== #}
                            <span class="badge
                {% if object.status == 'new' %}bg-secondary{% endif %}
                {% if object.status == 'in_progress' %}bg-primary{% endif %}
                {% if object.status == 'done' %}bg-success{% endif %}
                {% if object.status == 'failed' %}bg-warning text-dark{% endif %}
                {% if object.status == 'canceled' %}bg-danger{% endif %}
              ">
                {{ object.get_status_display }}
              </span>
                        </h1>

                        <div class="text-muted small">
                            Задача обслуживания · детали и материалы
                        </div>
                    </div>

                    <div class="btn-group">
                        <a class="btn btn-outline-secondary"
                           href="{% url 'maintenance:wo_list' %}">
                            ← К списку
                        </a>

                        <a class="btn btn-outline-primary"
                           href="{% url 'maintenance:wo_edit' object.pk %}">
                            Редактировать
                        </a>

                        <button
                                type="button"
                                class="btn btn-outline-danger"
                                data-confirm-delete
                                data-delete-url="{% url 'maintenance:wo_delete' object.pk %}"
                                data-delete-name="«{{ object.name }}»"
                                data-redirect-url="{% url 'maintenance:wo_list' %}"
                        >
                            Удалить
                        </button>
                    </div>
                </div>

                <!-- =====================================================
                     A. Статус и управление
                     ===================================================== -->
                {% if allowed_transitions %}
                <div class="form-section">
                    <div class="form-section-header">
                        Управление статусом
                    </div>

                    <div class="d-flex gap-2 flex-wrap">
                        {% for next_status, label in allowed_transitions.items %}
                        <form method="post"
                              action="{% url 'maintenance:wo_set_status' object.pk next_status %}">
                            {% csrf_token %}
                            <button type="submit"
                                    class="btn btn-sm
                        {% if next_status == 'in_progress' %}btn-outline-primary{% endif %}
                        {% if next_status == 'done' %}btn-outline-success{% endif %}
                        {% if next_status == 'failed' %}btn-outline-warning{% endif %}
                        {% if next_status == 'canceled' %}btn-outline-danger{% endif %}
                      ">
                                {{ label }}
                            </button>
                        </form>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- =====================================================
     B. Контекст выполнения
     ===================================================== -->
                <div class="form-section">
                    <div class="form-section-header">
                        Контекст выполнения
                    </div>

                    <div class="row g-3">

                        <!-- ===== Локация ===== -->
                        <div class="col-md-4">
                            <div class="text-muted small">Локация</div>
                            <div class="fw-semibold">
                                {% if object.location %}
                                <a href="{% url 'locations:location_detail' object.location.pk %}">
                                    {{ object.location }}
                                </a>
                                {% else %}
                                —
                                {% endif %}
                            </div>
                        </div>

                        <!-- ===== Оборудование + статус ===== -->
                        <div class="col-md-4">
                            <div class="text-muted small">Оборудование</div>

                            {% if object.workstation %}
                            <div class="fw-semibold mb-1">
                                <a href="{% url 'assets:asset_detail' object.workstation.pk %}">
                                    {{ object.workstation }}
                                </a>
                            </div>

                            <div class="d-flex align-items-center gap-2 flex-wrap">

    <span class="badge bg-secondary"
          id="ws-status-label">
        {{ object.workstation.get_status_display }}
    </span>

                                {% if request.user.is_staff %}
<button
    type="button"
    class="btn btn-sm btn-outline-secondary"
    id="ws-status-open-btn"
    title="Изменить статус оборудования">
    <i class="bi bi-pencil"></i>
</button>

                                {% endif %}
                            </div>

                            <div class="small text-muted mt-1 d-none"
                                 id="ws-status-hint">
                                Статус оборудования обновлён
                            </div>

                            {% else %}
                            —
                            {% endif %}
                        </div>

                        <!-- ===== Ответственный ===== -->
                        <div class="col-md-4">
                            <div class="text-muted small">Ответственный</div>
                            <div class="fw-semibold">
                                {% if object.responsible %}
                                <a href="{% url 'hr:hr_detail' object.responsible.pk %}">
                                    {{ object.responsible }}
                                </a>
                                {% else %}
                                —
                                {% endif %}
                            </div>
                        </div>

                    </div>
                </div>

                <!-- =====================================================
                     C. Параметры задачи (with styling)
                     ===================================================== -->
                <div class="form-section">
                    <div class="form-section-header">
                        Параметры задачи
                    </div>

                    <div class="row g-3">

                        <!-- Priority -->
                        <div class="col-md-4">
                            <div class="text-muted small">Приоритет</div>
                            <span class="badge
                {% if object.priority == 'low' %}bg-success{% endif %}
                {% if object.priority == 'medium' %}bg-warning text-dark{% endif %}
                {% if object.priority == 'high' %}bg-danger{% endif %}
              ">
                {{ object.get_priority_display }}
              </span>
                        </div>

                        <!-- Category -->
                        <div class="col-md-4">
                            <div class="text-muted small">Категория</div>

                            <span class="badge
    {% if object.category == 'inspection' %}bg-secondary{% endif %}
    {% if object.category == 'pm' %}bg-info text-dark{% endif %}
    {% if object.category == 'repair_minor' %}bg-warning text-dark{% endif %}
    {% if object.category == 'repair_major' %}bg-primary{% endif %}
    {% if object.category == 'emergency' %}bg-danger{% endif %}
  ">
    {{ object.get_category_display }}
  </span>
                        </div>

                        <!-- Labor -->
                        <div class="col-md-4">
                            <div class="text-muted small">
                                Трудоёмкость (план / факт), ч
                            </div>

                            {% if object.labor_fact_hours > object.labor_plan_hours %}
                            <div class="fw-semibold text-danger">
                                {{ object.labor_plan_hours }} / {{ object.labor_fact_hours }}
                                <small>(превышение)</small>
                            </div>
                            {% else %}
                            <div class="fw-semibold">
                                {{ object.labor_plan_hours }} / {{ object.labor_fact_hours }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <div class="text-muted small">Дата начала</div>
                            <div class="fw-semibold">
                                {{ object.date_start|default:"—" }}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="text-muted small">Дата окончания</div>
                            <div class="fw-semibold">
                                {{ object.date_finish|default:"—" }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- =====================================================
     D. Описание и вложения
     ===================================================== -->
                {% if object.description or object.attachments.exists %}
                <div class="form-section">
                    <div class="form-section-header">
                        Описание и вложения
                    </div>

                    {% if object.description %}
                    <div class="mb-3">
                        {{ object.description|linebreaks }}
                    </div>
                    {% endif %}

                    {% if object.attachments.exists %}
                    <ul class="list-group list-group-flush">
                        {% for att in object.attachments.all %}
                        <li class="list-group-item d-flex align-items-center gap-2">
                            <i class="bi bi-paperclip text-muted"></i>
                            <a href="{{ att.file.file.url }}"
                               target="_blank"
                               rel="noopener"
                               class="text-decoration-none">
                                {{ att.file.file.name|cut:"workorders/" }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
                {% endif %}

                <!-- =====================================================
                     E. Материалы
                     ===================================================== -->
                <div class="form-section">
                    <div class="form-section-header">
                        Материалы
                    </div>

                    {% if object.materials.all %}
                    <ul class="list-group list-group-flush">
                        {% for m in object.materials.all %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="fw-semibold">
                                {{ m.material.name }}
                            </div>
                            <div class="text-muted small">
                                план: {{ m.qty_planned }} · факт: {{ m.qty_used }}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="text-muted">
                        Материалы не добавлены
                    </div>
                    {% endif %}
                </div>

            </div>
        </div>

    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const openBtn = document.getElementById("ws-status-open-btn");
    const saveBtn = document.getElementById("ws-status-modal-save");
    const select  = document.getElementById("ws-status-modal-select");
    const label   = document.getElementById("ws-status-label");
    const hint    = document.getElementById("ws-status-hint");
    const modalEl = document.getElementById("wsStatusModal");

    if (!openBtn || !saveBtn || !select || !modalEl) return;

    // =========================
    // CSRF
    // =========================
    function getCSRFToken() {
        const el = document.querySelector('#csrf-vault [name=csrfmiddlewaretoken]');
        if (el?.value) return el.value;

        const m = document.cookie.match(/csrftoken=([^;]+)/);
        return m ? decodeURIComponent(m[1]) : null;
    }

    // =========================
    // Badge styles
    // =========================
    function badgeClass(status) {
        return {
            ok: "bg-success",
            problem: "bg-danger",
            maintenance: "bg-warning text-dark",
            disabled: "bg-secondary",
        }[status] || "bg-secondary";
    }

    // =========================
    // ONE modal instance
    // =========================
    const modal = new bootstrap.Modal(modalEl, {
        backdrop: true,
        keyboard: true,
        focus: true,
    });

    // =========================
    // Open modal (ONLY via JS)
    // =========================
    openBtn.addEventListener("click", () => {
        modal.show();
    });

    // =========================
    // Save handler
    // =========================
    saveBtn.addEventListener("click", function () {
        const status = select.value;
        const token  = getCSRFToken();

        if (!token) {
            alert("CSRF token не найден. Обновите страницу.");
            return;
        }

        saveBtn.disabled = true;

        fetch("{% url 'maintenance:ajax_workstation_status_update' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": token,
                "X-Requested-With": "XMLHttpRequest",
                "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
            },
            body:
                "id={{ object.workstation.pk }}&status=" +
                encodeURIComponent(status),
        })
        .then(async r => {
            const data = await r.json().catch(() => ({}));
            if (!r.ok || !data.ok) throw data;
            return data;
        })
        .then(() => {
            // UI update
            label.textContent =
                select.options[select.selectedIndex].text;
            label.className =
                "badge " + badgeClass(status);

            hint.classList.remove("d-none");
            setTimeout(() => hint.classList.add("d-none"), 2000);

            modal.hide();
        })
        .catch(err => {
            console.error(err);
            alert(err?.error || "Ошибка обновления статуса");
        })
        .finally(() => {
            saveBtn.disabled = false;
        });
    });

});
</script>

{% if object.workstation and request.user.is_staff %}
{% include "includes/workstation_status_modal.html" %}
{% endif %}

{% endblock %}

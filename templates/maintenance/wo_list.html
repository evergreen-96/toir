{% extends "base.html" %}
{% block title %}Задачи{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="mb-0">Задачи</h1>
  <a class="btn btn-success" href="{% url 'maintenance:wo_new' %}">+ Новая задача</a>
</div>

<form class="row g-2 mb-3" method="get">
  <div class="col-md-4"><input class="form-control" type="search" name="q" placeholder="Поиск по названию/описанию" value="{{ q }}"></div>
  <div class="col-md-2">
    <select class="form-select" name="status">
      <option value="">Статус: все</option>
      {% for v, label in status_choices %}<option value="{{ v }}" {% if current.status == v %}selected{% endif %}>{{ label }}</option>{% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <select class="form-select" name="priority">
      <option value="">Приоритет: все</option>
      {% for v, label in priority_choices %}<option value="{{ v }}" {% if current.priority == v %}selected{% endif %}>{{ label }}</option>{% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <select class="form-select" name="category">
      <option value="">Категория: все</option>
      {% for v, label in category_choices %}<option value="{{ v }}" {% if current.category == v %}selected{% endif %}>{{ label }}</option>{% endfor %}
    </select>
  </div>
  <div class="col-md-2"><button class="btn btn-primary w-100" type="submit">Фильтр</button></div>
</form>

<table class="table table-hover align-middle">
  <thead class="table-light"><tr>
    <th>#</th><th>Название</th><th>Статус</th><th>Приоритет</th><th>Категория</th><th>Оборудование/Локация</th><th>Ответственный</th>
  </tr></thead>
  <tbody>
  {% for wo in object_list %}
    <tr onclick="window.location.href='{% url 'maintenance:wo_detail' wo.pk %}'" style="cursor:pointer">
      <td class="text-muted">#{{ wo.pk }}</td>
      <td class="fw-semibold">{{ wo.name }}</td>
      <td>
        {% if wo.status == 'new' %}<span class="badge text-bg-primary badge-pill">Новое</span>
        {% elif wo.status == 'in_progress' %}<span class="badge text-bg-warning badge-pill">В работе</span>
        {% elif wo.status == 'done' %}<span class="badge text-bg-success badge-pill">Выполнено</span>
        {% elif wo.status == 'failed' %}<span class="badge text-bg-danger badge-pill">Не выполнено</span>
        {% elif wo.status == 'canceled' %}<span class="badge text-bg-secondary badge-pill">Отмена</span>
        {% else %}—{% endif %}
      </td>
      <td>
        {% if wo.priority == 'high' %}<span class="badge text-bg-danger badge-pill">Высокий</span>
        {% elif wo.priority == 'med' %}<span class="badge text-bg-warning badge-pill">Средний</span>
        {% else %}<span class="badge text-bg-secondary badge-pill">Низкий</span>{% endif %}
      </td>
      <td>{{ wo.get_category_display }}</td>
      <td>
        {% if wo.workstation %}{{ wo.workstation.name }}{% endif %}
        {% if wo.location %}<div class="text-muted small">{{ wo.location.name }}</div>{% endif %}
      </td>
      <td>{{ wo.responsible }}</td>
    </tr>
  {% empty %}
    <tr><td colspan="7"><div class="alert alert-secondary mb-0">Пока задач нет</div></td></tr>
  {% endfor %}
  </tbody>
</table>

{% if is_paginated %}
<nav class="mt-3">
  <ul class="pagination">
    {% if page_obj.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}&status={{ current.status }}&priority={{ current.priority }}&category={{ current.category }}">Назад</a></li>
    {% endif %}
    <li class="page-item disabled"><span class="page-link">Стр. {{ page_obj.number }} из {{ paginator.num_pages }}</span></li>
    {% if page_obj.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}&status={{ current.status }}&priority={{ current.priority }}&category={{ current.category }}">Вперёд</a></li>
    {% endif %}
  </ul>
</nav>
{% endif %}
{% endblock %}

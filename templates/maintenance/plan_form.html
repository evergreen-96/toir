{% extends "base.html" %}
{% load static form_extras %}

{% block title %}{% if create %}Новый план{% else %}Редактирование плана{% endif %}{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<style>
/* Tom Select */
.ts-wrapper { width: 100% !important; }
.form-select.js-tom-select-location,
.form-select.js-tom-select-workstation,
.form-select.js-tom-select-responsible { background-image: none !important; }
.ts-dropdown { z-index: 1060 !important; }
.ts-wrapper.disabled .ts-control { cursor: not-allowed !important; opacity: 0.6; background-color: var(--bs-secondary-bg) !important; }
[data-bs-theme="dark"] .ts-control { background-color: var(--bs-dark) !important; color: #e9ecef !important; }
[data-bs-theme="dark"] .ts-dropdown { background-color: var(--bs-dark) !important; }

/* Calendar */
.calendar-month { margin-bottom: 1.5rem; }
.calendar-month-title { font-weight: 600; margin-bottom: 0.5rem; color: var(--bs-primary); }
.calendar-grid-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px; }
.calendar-grid-header span { text-align: center; font-size: 0.75rem; color: var(--bs-secondary); font-weight: 500; }
.calendar-grid-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
.calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border-radius: 4px; background: var(--bs-tertiary-bg); }
.calendar-day.empty { background: transparent; }
.calendar-day.today { border: 2px solid var(--bs-primary); font-weight: bold; }
.calendar-day.first { background: var(--bs-success); color: white; font-weight: bold; }
.calendar-day.next { background: var(--bs-primary); color: white; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- HEADER -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
        <div class="mb-3 mb-md-0">
            <nav aria-label="breadcrumb" class="mb-2">
                <ol class="breadcrumb small mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'maintenance:plan_list' %}" class="text-decoration-none">Планы</a></li>
                    {% if not create and object %}<li class="breadcrumb-item"><a href="{% url 'maintenance:plan_detail' object.pk %}" class="text-decoration-none">{{ object.name|truncatechars:20 }}</a></li>{% endif %}
                    <li class="breadcrumb-item active">{% if create %}Новый{% else %}Редактирование{% endif %}</li>
                </ol>
            </nav>
            <h1 class="h2 mb-1">
                {% if create %}<i class="bi bi-plus-circle me-2 text-success"></i>Новый план
                {% else %}<i class="bi bi-pencil-square me-2 text-primary"></i>Редактирование{% endif %}
            </h1>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="{% url 'maintenance:plan_list' %}"><i class="bi bi-arrow-left me-1"></i>Назад</a>
            {% if not create %}<a class="btn btn-outline-info" href="{% url 'maintenance:plan_detail' object.pk %}"><i class="bi bi-eye me-1"></i>Просмотр</a>{% endif %}
        </div>
    </div>

    <form method="post" novalidate>
        {% csrf_token %}
        {{ form.interval_value }}
        {{ form.interval_unit }}

        {% if form.non_field_errors %}
        <div class="alert alert-danger mb-4"><i class="bi bi-exclamation-triangle me-2"></i>{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="row">
            <!-- ЛЕВАЯ КОЛОНКА -->
            <div class="col-lg-8">
                <!-- Основная информация -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-dark border-0">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2 text-primary"></i>Основная информация</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-semibold">{{ form.name.label }} <span class="text-danger">*</span></label>
                                {{ form.name }}
                                {% if form.name.errors %}<div class="invalid-feedback d-block">{{ form.name.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">{{ form.category.label }}</label>
                                {{ form.category }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">{{ form.priority.label }}</label>
                                {{ form.priority }}
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-semibold">{{ form.description.label }}</label>
                                {{ form.description }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Оборудование и локация -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-dark border-0">
                        <h5 class="mb-0"><i class="bi bi-cpu me-2 text-primary"></i>Оборудование и локация</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">{{ form.location.label }} <span class="text-danger">*</span></label>
                                {{ form.location }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">{{ form.workstation.label }} <span class="text-danger">*</span></label>
                                {{ form.workstation }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Периодичность -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-dark border-0">
                        <h5 class="mb-0"><i class="bi bi-clock-history me-2 text-primary"></i>Периодичность выполнения</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            {% for value, label in form.frequency_choice.field.choices %}
                            <div class="form-check mb-2">
                                <input class="form-check-input frequency-choice" type="radio" name="{{ form.frequency_choice.name }}" id="id_frequency_choice_{{ forloop.counter0 }}" value="{{ value }}" {% if form.frequency_choice.value == value %}checked{% elif not form.frequency_choice.value and value == 'weekly' %}checked{% endif %}>
                                <label class="form-check-label" for="id_frequency_choice_{{ forloop.counter0 }}">{{ label }}</label>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Ежедневно -->
                        <div id="frequency-daily-fields" style="display: none;">
                            <div class="card bg-body-tertiary mb-3">
                                <div class="card-body">
                                    <h6 class="card-title mb-3"><i class="bi bi-calendar-check me-2"></i>Ежедневное обслуживание</h6>
                                    <label for="{{ form.first_run_date.id_for_label }}" class="form-label">{{ form.first_run_date.label }} <span class="text-danger">*</span></label>
                                    {{ form.first_run_date }}
                                </div>
                            </div>
                        </div>

                        <!-- Еженедельно -->
                        <div id="frequency-weekly-fields" style="display: none;">
                            <div class="card bg-body-tertiary mb-3">
                                <div class="card-body">
                                    <h6 class="card-title mb-3"><i class="bi bi-calendar-week me-2"></i>Еженедельное обслуживание</h6>
                                    <label for="{{ form.weekday.id_for_label }}" class="form-label">{{ form.weekday.label }} <span class="text-danger">*</span></label>
                                    {{ form.weekday }}
                                </div>
                            </div>
                        </div>

                        <!-- Ежемесячно -->
                        <div id="frequency-monthly-fields" style="display: none;">
                            <div class="card bg-body-tertiary mb-3">
                                <div class="card-body">
                                    <h6 class="card-title mb-3"><i class="bi bi-calendar-month me-2"></i>Ежемесячное обслуживание</h6>
                                    <label for="{{ form.day_of_month.id_for_label }}" class="form-label">{{ form.day_of_month.label }} <span class="text-danger">*</span></label>
                                    {{ form.day_of_month }}
                                </div>
                            </div>
                        </div>

                        <!-- Произвольный -->
                        <div id="frequency-custom-fields" style="display: none;">
                            <div class="card bg-body-tertiary mb-3">
                                <div class="card-body">
                                    <h6 class="card-title mb-3"><i class="bi bi-gear me-2"></i>Произвольный интервал</h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3 mb-md-0">
                                            <label for="custom_interval_value" class="form-label">Значение <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="custom_interval_value" min="1" value="1">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="custom_interval_unit" class="form-label">Единица <span class="text-danger">*</span></label>
                                            <select class="form-select" id="custom_interval_unit">
                                                {% for value, label in form.interval_unit.field.choices %}
                                                <option value="{{ value }}">{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Исполнение -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-dark border-0">
                        <h5 class="mb-0"><i class="bi bi-person me-2 text-primary"></i>Исполнение</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">{{ form.responsible_default.label }} <span class="text-danger">*</span></label>
                                {{ form.responsible_default }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">{{ form.labor_plan_hours.label }}</label>
                                {{ form.labor_plan_hours }}
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch mt-3">
                                    {{ form.is_active }}
                                    <label class="form-check-label fw-semibold" for="{{ form.is_active.id_for_label }}">{{ form.is_active.label }}</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ПРАВАЯ КОЛОНКА -->
            <div class="col-lg-4">
                <div class="sticky-top" style="top: 20px;">
                    <!-- Кнопки -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-check-lg me-2"></i>{% if create %}Создать{% else %}Сохранить{% endif %}
                                </button>
                                {% if create %}
                                <button type="submit" name="save_and_add" value="1" class="btn btn-outline-success">
                                    <i class="bi bi-plus-circle me-2"></i>Сохранить и добавить ещё
                                </button>
                                {% endif %}
                                <a href="{% if create %}{% url 'maintenance:plan_list' %}{% else %}{% url 'maintenance:plan_detail' object.pk %}{% endif %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-lg me-2"></i>Отмена
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Превью расписания -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-dark border-0">
                            <h5 class="mb-0"><i class="bi bi-calendar-event me-2 text-primary"></i>Превью расписания</h5>
                        </div>
                        <div class="card-body">
                            <div id="preview-loading" class="text-center py-3" style="display: none;">
                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                <span class="ms-2">Расчет...</span>
                            </div>
                            <div id="preview-error" class="alert alert-warning small" style="display: none;"></div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between small">
                                    <span class="text-muted">Первый запуск:</span>
                                    <strong id="preview-first-run" class="text-primary">—</strong>
                                </div>
                                <div class="d-flex justify-content-between small">
                                    <span class="text-muted">Запусков (6 мес.):</span>
                                    <strong id="preview-count" class="text-success">—</strong>
                                </div>
                            </div>
                            <hr>
                            <div id="preview-calendar" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // =====================================================
    // TOM SELECT
    // =====================================================
    let locationSelect = null;
    let workstationSelect = null;

    const locationElement = document.querySelector('.js-tom-select-location');
    if (locationElement) {
        locationSelect = new TomSelect(locationElement, {
            maxOptions: null, placeholder: 'Выберите локацию...', allowEmptyOption: true,
            searchField: ['text'], sortField: { field: 'text', direction: 'asc' },
            onInitialize: function() { if (locationElement.value) this.setValue(locationElement.value); },
            onChange: function(value) { loadWorkstations(value); }
        });
    }

    const workstationElement = document.querySelector('.js-tom-select-workstation');
    if (workstationElement) {
        workstationSelect = new TomSelect(workstationElement, {
            maxOptions: null, placeholder: 'Сначала выберите локацию...', allowEmptyOption: true,
            searchField: ['text'], sortField: { field: 'text', direction: 'asc' },
            onInitialize: function() {
                if (workstationElement.value) this.setValue(workstationElement.value);
                if (!locationSelect || !locationSelect.getValue()) this.disable();
            }
        });
    }

    const responsibleElement = document.querySelector('.js-tom-select-responsible');
    if (responsibleElement) {
        new TomSelect(responsibleElement, {
            maxOptions: null, placeholder: 'Выберите ответственного...', allowEmptyOption: true,
            searchField: ['text'], sortField: { field: 'text', direction: 'asc' },
            onInitialize: function() { if (responsibleElement.value) this.setValue(responsibleElement.value); }
        });
    }

    function loadWorkstations(locationId) {
        if (!workstationSelect) return;
        workstationSelect.clear(); workstationSelect.clearOptions();
        if (!locationId) {
            workstationSelect.settings.placeholder = 'Сначала выберите локацию...';
            workstationSelect.disable(); workstationSelect.inputState(); return;
        }
        workstationSelect.settings.placeholder = 'Загрузка...';
        workstationSelect.disable(); workstationSelect.inputState();

        fetch('{% url "maintenance:api_workstations" %}?location=' + locationId)
            .then(r => r.json())
            .then(data => {
                if (data && data.length > 0) {
                    data.forEach(item => workstationSelect.addOption({ value: item.id, text: item.name }));
                    workstationSelect.settings.placeholder = 'Выберите оборудование...';
                    workstationSelect.enable();
                } else {
                    workstationSelect.settings.placeholder = 'Нет оборудования';
                    workstationSelect.disable();
                }
                workstationSelect.inputState();
            });
    }

    {% if not create and object.location_id %}
    if (locationSelect && workstationSelect) {
        const currentWorkstation = '{{ object.workstation_id|default:"" }}';
        fetch('{% url "maintenance:api_workstations" %}?location={{ object.location_id }}')
            .then(r => r.json())
            .then(data => {
                if (data && data.length > 0) {
                    workstationSelect.clearOptions();
                    data.forEach(item => workstationSelect.addOption({ value: item.id, text: item.name }));
                    if (currentWorkstation) workstationSelect.setValue(currentWorkstation);
                    workstationSelect.enable();
                }
            });
    }
    {% endif %}

    // =====================================================
    // ПЕРИОДИЧНОСТЬ
    // =====================================================
    const radios = document.querySelectorAll(".frequency-choice");
    const dailyFields = document.getElementById("frequency-daily-fields");
    const weeklyFields = document.getElementById("frequency-weekly-fields");
    const monthlyFields = document.getElementById("frequency-monthly-fields");
    const customFields = document.getElementById("frequency-custom-fields");
    const hiddenValue = document.querySelector(".interval-value-field");
    const hiddenUnit = document.querySelector(".interval-unit-field");
    const customValue = document.getElementById("custom_interval_value");
    const customUnit = document.getElementById("custom_interval_unit");

    function getSelectedFrequency() { return Array.from(radios).find(r => r.checked)?.value || "weekly"; }

    function updateFrequencyUI() {
        const freq = getSelectedFrequency();
        if (dailyFields) dailyFields.style.display = "none";
        if (weeklyFields) weeklyFields.style.display = "none";
        if (monthlyFields) monthlyFields.style.display = "none";
        if (customFields) customFields.style.display = "none";

        switch (freq) {
            case "daily": if (dailyFields) dailyFields.style.display = "block"; if (hiddenValue) hiddenValue.value = "1"; if (hiddenUnit) hiddenUnit.value = "day"; break;
            case "weekly": if (weeklyFields) weeklyFields.style.display = "block"; if (hiddenValue) hiddenValue.value = "1"; if (hiddenUnit) hiddenUnit.value = "week"; break;
            case "monthly": if (monthlyFields) monthlyFields.style.display = "block"; if (hiddenValue) hiddenValue.value = "1"; if (hiddenUnit) hiddenUnit.value = "month"; break;
            case "custom": if (customFields) customFields.style.display = "block"; if (hiddenValue && customValue) hiddenValue.value = customValue.value; if (hiddenUnit && customUnit) hiddenUnit.value = customUnit.value; break;
        }
    }

    updateFrequencyUI();
    radios.forEach(r => r.addEventListener("change", () => { updateFrequencyUI(); schedulePreviewRefresh(); }));
    if (customValue) customValue.addEventListener("input", () => { if (hiddenValue) hiddenValue.value = customValue.value; schedulePreviewRefresh(); });
    if (customUnit) customUnit.addEventListener("change", () => { if (hiddenUnit) hiddenUnit.value = customUnit.value; schedulePreviewRefresh(); });

    // =====================================================
    // ПРЕВЬЮ КАЛЕНДАРЯ
    // =====================================================
    const MONTHS_AHEAD = 6;
    const previewCalendar = document.getElementById("preview-calendar");
    const previewLoading = document.getElementById("preview-loading");
    const previewError = document.getElementById("preview-error");
    const previewFirstRun = document.getElementById("preview-first-run");
    const previewCount = document.getElementById("preview-count");
    const MONTH_NAMES = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];
    const DOW_SHORT = ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"];

    function setError(text) { previewError.style.display = text ? "block" : "none"; previewError.textContent = text || ""; }
    function monthsInRange(start, end) { const arr = []; let d = new Date(start); while (d <= end) { arr.push([d.getFullYear(), d.getMonth()]); d.setMonth(d.getMonth() + 1); } return arr; }
    function firstDayOfMonth(y, m0) { let wd = new Date(y, m0, 1).getDay(); return wd === 0 ? 6 : wd - 1; }
    function daysInMonth(y, m0) { return new Date(y, m0 + 1, 0).getDate(); }
    function toISO(y, m0, d) { return `${y}-${String(m0 + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`; }

    function buildMonthNode(year, month0, todayISO, firstDayISO, nextDaysSet) {
        const wrap = document.createElement("div"); wrap.className = "calendar-month";
        const title = document.createElement("div"); title.className = "calendar-month-title"; title.textContent = `${MONTH_NAMES[month0]} ${year}`; wrap.appendChild(title);
        const header = document.createElement("div"); header.className = "calendar-grid-header";
        DOW_SHORT.forEach(d => { const span = document.createElement("span"); span.textContent = d; header.appendChild(span); }); wrap.appendChild(header);
        const grid = document.createElement("div"); grid.className = "calendar-grid-days";
        const startWd = firstDayOfMonth(year, month0);
        for (let i = 0; i < startWd; i++) { const empty = document.createElement("div"); empty.className = "calendar-day empty"; grid.appendChild(empty); }
        const days = daysInMonth(year, month0);
        for (let day = 1; day <= days; day++) {
            const cell = document.createElement("div"); cell.className = "calendar-day";
            const iso = toISO(year, month0, day);
            if (iso === firstDayISO) cell.classList.add("first");
            else if (nextDaysSet.has(iso)) cell.classList.add("next");
            if (iso === todayISO) cell.classList.add("today");
            cell.textContent = String(day); grid.appendChild(cell);
        }
        wrap.appendChild(grid); return wrap;
    }

    function renderCalendars(todayISO, firstRunStr, runsStr) {
        previewCalendar.innerHTML = "";
        const firstDayISO = firstRunStr.slice(0, 10);
        const runDaysISO = runsStr.map(x => x.slice(0, 10));
        const nextDaysSet = new Set(runDaysISO.filter(x => x !== firstDayISO));
        const today = new Date(todayISO + "T00:00:00");
        const end = new Date(today); end.setMonth(end.getMonth() + MONTHS_AHEAD);
        monthsInRange(today, end).forEach(([y, m0]) => { previewCalendar.appendChild(buildMonthNode(y, m0, todayISO, firstDayISO, nextDaysSet)); });
    }

    let _previewTimer = null;
    function schedulePreviewRefresh() { if (_previewTimer) clearTimeout(_previewTimer); _previewTimer = setTimeout(refreshPreview, 300); }

    async function refreshPreview() {
        setError("");
        if (previewLoading) previewLoading.style.display = "block";
        const freq = getSelectedFrequency();
        const params = new URLSearchParams();
        params.set("frequency_choice", freq);
        params.set("months_ahead", String(MONTHS_AHEAD));
        if (hiddenValue) params.set("interval_value", hiddenValue.value || "");
        if (hiddenUnit) params.set("interval_unit", hiddenUnit.value || "");
        params.set("first_run_date", document.getElementById("id_first_run_date")?.value || "");
        params.set("weekday", document.getElementById("id_weekday")?.value || "");
        params.set("day_of_month", document.getElementById("id_day_of_month")?.value || "");
        if (freq === "custom") { params.set("interval_value", customValue?.value || ""); params.set("interval_unit", customUnit?.value || ""); }

        if (freq === "daily" && !params.get("first_run_date")) { if (previewLoading) previewLoading.style.display = "none"; return; }
        if (freq === "weekly" && !params.get("weekday")) { if (previewLoading) previewLoading.style.display = "none"; return; }
        if (freq === "monthly" && !params.get("day_of_month")) { if (previewLoading) previewLoading.style.display = "none"; return; }
        if (freq === "custom" && (!params.get("interval_value") || !params.get("interval_unit"))) { if (previewLoading) previewLoading.style.display = "none"; return; }

        try {
            const r = await fetch("{% url 'maintenance:plan_preview' %}?" + params.toString(), {headers: {"X-Requested-With": "XMLHttpRequest"}});
            const data = await r.json();
            if (previewLoading) previewLoading.style.display = "none";
            if (!data.ok) { setError(data.error || "Ошибка"); return; }
            if (previewFirstRun) previewFirstRun.textContent = data.first_run;
            if (previewCount) previewCount.textContent = data.runs.length;
            if (previewCalendar) renderCalendars(data.today, data.first_run, data.runs);
        } catch (e) {
            if (previewLoading) previewLoading.style.display = "none";
            setError("Не удалось получить превью");
        }
    }

    document.getElementById("id_first_run_date")?.addEventListener("change", schedulePreviewRefresh);
    document.getElementById("id_weekday")?.addEventListener("change", schedulePreviewRefresh);
    document.getElementById("id_day_of_month")?.addEventListener("input", schedulePreviewRefresh);
    schedulePreviewRefresh();
});
</script>
{% endblock %}

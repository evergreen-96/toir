{% extends "base.html" %}
{% load static %}

{% block title %}Плановые работы{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- HEADER -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
        <div class="mb-3 mb-md-0">
            <h1 class="h2 mb-1"><i class="bi bi-calendar-check me-2 text-primary"></i>Плановые работы</h1>
            <div class="text-muted small">Расписание регулярного технического обслуживания</div>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center">
            {% include "components/view_mode_toggle.html" with storage_key="plan_view_mode" %}
            <a class="btn btn-primary" href="{% url 'maintenance:plan_new' %}">
                <i class="bi bi-plus-lg me-1"></i>Новый план
            </a>
        </div>
    </div>

    <!-- СТАТИСТИКА -->
    {% if stats %}
    <div class="row g-3 mb-4">
        <div class="col-md-4 col-sm-6">{% include "components/stat_card.html" with title="Всего планов" value=stats.total icon="bi-calendar" color="primary" %}</div>
        <div class="col-md-4 col-sm-6">{% include "components/stat_card.html" with title="Активных" value=stats.active icon="bi-check-circle" color="success" %}</div>
        <div class="col-md-4 col-sm-6">{% include "components/stat_card.html" with title="Неактивных" value=stats.inactive icon="bi-pause-circle" color="secondary" %}</div>
    </div>
    {% endif %}

    <!-- ФИЛЬТРЫ -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-dark border-0 d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-funnel me-2 text-primary"></i>Фильтры</h5>
            <button class="btn btn-sm btn-link text-muted p-0" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>
        <div class="collapse show" id="filterCollapse">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-xl-4 col-md-6">
                        {% include "components/search_input.html" with name="q" value=filter_params.q placeholder="Название, описание..." label="Поиск" %}
                    </div>
                    <div class="col-xl-2 col-md-4">
                        <label class="form-label small mb-1"><i class="bi bi-power me-1"></i>Статус</label>
                        <select name="is_active" class="form-select">
                            <option value="">Все</option>
                            <option value="1" {% if filter_params.is_active == "1" %}selected{% endif %}>Активные</option>
                            <option value="0" {% if filter_params.is_active == "0" %}selected{% endif %}>Неактивные</option>
                        </select>
                    </div>
                    <div class="col-xl-2 col-md-4">
                        <label class="form-label small mb-1"><i class="bi bi-clock me-1"></i>Интервал</label>
                        <select name="interval_unit" class="form-select">
                            <option value="">Все</option>
                            {% for value, label in interval_units %}<option value="{{ value }}" {% if filter_params.interval_unit == value %}selected{% endif %}>{{ label }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-xl-4 col-md-12 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-primary"><i class="bi bi-search me-1"></i>Применить</button>
                        <a href="{% url 'maintenance:plan_list' %}" class="btn btn-outline-secondary"><i class="bi bi-x-lg me-1"></i>Сбросить</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- КАРТОЧКИ -->
    <div id="cards-view">
        {% if plans %}
        <div class="row g-3">
            {% for plan in plans %}
            <div class="col-xl-3 col-lg-4 col-md-6">
                <div class="card h-100 border hover-shadow">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            {% if plan.is_active %}
                            <span class="badge bg-success-subtle text-success-emphasis border"><i class="bi bi-check-circle me-1"></i>Активен</span>
                            {% else %}
                            <span class="badge bg-secondary-subtle text-secondary-emphasis border"><i class="bi bi-pause-circle me-1"></i>Неактивен</span>
                            {% endif %}
                            <span class="badge bg-light text-dark border">{{ plan.interval_value }} {{ plan.get_interval_unit_display }}</span>
                        </div>
                        <h6 class="card-title mb-1">
                            <a href="{% url 'maintenance:plan_detail' plan.pk %}" class="text-decoration-none text-body">{{ plan.name|truncatechars:35 }}</a>
                        </h6>
                        {% if plan.workstation %}
                        <div class="small mb-1"><i class="bi bi-cpu me-1 text-muted"></i>{{ plan.workstation.name|truncatechars:25 }}</div>
                        {% endif %}
                        {% if plan.location %}
                        <div class="small mb-1"><i class="bi bi-geo-alt me-1 text-muted"></i>{{ plan.location.name }}</div>
                        {% endif %}
                        {% if plan.next_run %}
                        <div class="small mb-2">
                            <i class="bi bi-calendar me-1 text-muted"></i>
                            Следующий: <span class="fw-semibold">{{ plan.next_run|date:"d.m.Y H:i" }}</span>
                        </div>
                        {% endif %}
                        <div class="mt-auto pt-3 border-top d-flex gap-1">
                            <a href="{% url 'maintenance:plan_detail' plan.pk %}" class="btn btn-sm btn-outline-primary" title="Просмотр"><i class="bi bi-eye"></i></a>
                            <a href="{% url 'maintenance:plan_edit' plan.pk %}" class="btn btn-sm btn-outline-secondary" title="Редактировать"><i class="bi bi-pencil"></i></a>
                            {% if plan.is_active %}
                            <form method="post" action="{% url 'maintenance:plan_run_now' plan.pk %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-success" title="Запустить сейчас"><i class="bi bi-play"></i></button>
                            </form>
                            {% endif %}
                            <button type="button" class="btn btn-sm btn-outline-danger" title="Удалить" data-bs-toggle="modal" data-bs-target="#deleteModal" data-delete-url="{% url 'maintenance:plan_delete' plan.pk %}" data-delete-name="{{ plan.name }}"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        {% include "components/empty_state.html" with message="Плановые работы не найдены" icon="bi-calendar" subtitle="Создайте первый план" action_url="/workorders/plans/new/" action_text="Создать план" %}
        {% endif %}
    </div>

    <!-- ТАБЛИЦА -->
    <div id="table-view" class="d-none">
        {% if plans %}
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Название</th>
                        <th>Оборудование</th>
                        <th>Интервал</th>
                        <th>Следующий запуск</th>
                        <th>Статус</th>
                        <th>Ответственный</th>
                        <th style="width: 130px;">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for plan in plans %}
                    <tr>
                        <td><a href="{% url 'maintenance:plan_detail' plan.pk %}" class="text-decoration-none fw-semibold">{{ plan.name|truncatechars:35 }}</a></td>
                        <td>{{ plan.workstation.name|default:"—"|truncatechars:20 }}</td>
                        <td>{{ plan.interval_value }} {{ plan.get_interval_unit_display }}</td>
                        <td>{{ plan.next_run|date:"d.m.Y H:i"|default:"—" }}</td>
                        <td>{% if plan.is_active %}<span class="badge bg-success-subtle text-success-emphasis border">Активен</span>{% else %}<span class="badge bg-secondary-subtle text-secondary-emphasis border">Неактивен</span>{% endif %}</td>
                        <td>{{ plan.responsible_default.name|default:"—" }}</td>
                        <td>
                            <div class="d-flex gap-1">
                                <a href="{% url 'maintenance:plan_edit' plan.pk %}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil"></i></a>
                                {% if plan.is_active %}
                                <form method="post" action="{% url 'maintenance:plan_run_now' plan.pk %}" class="d-inline">{% csrf_token %}<button type="submit" class="btn btn-sm btn-outline-success"><i class="bi bi-play"></i></button></form>
                                {% endif %}
                                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" data-delete-url="{% url 'maintenance:plan_delete' plan.pk %}" data-delete-name="{{ plan.name }}"><i class="bi bi-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        {% include "components/empty_state.html" with message="Плановые работы не найдены" icon="bi-calendar" %}
        {% endif %}
    </div>

    {% if page_obj.has_other_pages %}{% include "core/partials/pagination.html" with page_obj=page_obj %}{% endif %}
</div>

{% include "components/delete_modal.html" with modal_id="deleteModal" title="Удалить план?" %}
{% endblock %}

{% block extra_js %}
{% include "components/view_mode_toggle_js.html" with storage_key="plan_view_mode" %}
{% include "components/delete_modal_js.html" with modal_id="deleteModal" csrf_token=csrf_token %}
{% endblock %}

{% extends "base.html" %}
{% load static form_extras %}

{% block title %}{% if create %}Новая заявка{% else %}Редактирование заявки{% endif %}{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<style>
/* Tom Select */
.ts-wrapper { width: 100% !important; }
.form-select.js-tom-select-location,
.form-select.js-tom-select-workstation,
.form-select.js-tom-select-responsible,
.material-select { background-image: none !important; }
.ts-dropdown { z-index: 1060 !important; }
.ts-wrapper.disabled .ts-control { cursor: not-allowed !important; opacity: 0.6; background-color: var(--bs-secondary-bg) !important; }
[data-bs-theme="dark"] .ts-control { background-color: var(--bs-dark) !important; color: #e9ecef !important; }
[data-bs-theme="dark"] .ts-dropdown { background-color: var(--bs-dark) !important; }

/* Материалы */
.material-row { padding: 0.75rem; border-radius: 0.5rem; background: var(--bs-tertiary-bg); border: 1px solid var(--bs-border-color); }
.material-row.is-removed { opacity: 0.5; background-color: var(--bs-danger-bg-subtle); }
.material-row input[type="number"] { display: block; width: 100%; padding: .375rem .75rem; font-size: 1rem; font-weight: 400; line-height: 1.5; color: var(--bs-body-color); background-color: var(--bs-body-bg); background-clip: padding-box; border: 1px solid var(--bs-border-color); border-radius: .375rem; transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out; }
.material-row input[type="number"]:focus { color: var(--bs-body-color); background-color: var(--bs-body-bg); border-color: #86b7fe; outline: 0; box-shadow: 0 0 0 .25rem rgba(13,110,253,.25); }

/* Файлы */
.file-thumb-container { display: flex; align-items: center; gap: 12px; }
.file-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; cursor: zoom-in; border: 1px solid var(--bs-border-color); }
.file-thumb:hover { transform: scale(1.02); box-shadow: 0 .25rem .75rem rgba(0,0,0,.15); }
.file-thumb-icon { width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; color: var(--bs-secondary-color); font-size: 24px; border-radius: 6px; border: 1px solid var(--bs-border-color); background: var(--bs-tertiary-bg); }
.file-info { flex: 1; min-width: 0; }
.file-row.is-removed { opacity: 0.5; text-decoration: line-through; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- HEADER -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
        <div class="mb-3 mb-md-0">
            <nav aria-label="breadcrumb" class="mb-2">
                <ol class="breadcrumb small mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'maintenance:wo_list' %}" class="text-decoration-none">Заявки</a></li>
                    {% if not create and object %}<li class="breadcrumb-item"><a href="{% url 'maintenance:wo_detail' object.pk %}" class="text-decoration-none">#{{ object.pk }}</a></li>{% endif %}
                    <li class="breadcrumb-item active">{% if create %}Новая{% else %}Редактирование{% endif %}</li>
                </ol>
            </nav>
            <h1 class="h2 mb-1">
                {% if create %}<i class="bi bi-plus-circle me-2 text-success"></i>Новая заявка
                {% else %}<i class="bi bi-pencil-square me-2 text-primary"></i>Редактирование{% endif %}
            </h1>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="{% url 'maintenance:wo_list' %}"><i class="bi bi-arrow-left me-1"></i>Назад</a>
            {% if not create %}<a class="btn btn-outline-info" href="{% url 'maintenance:wo_detail' object.pk %}"><i class="bi bi-eye me-1"></i>Просмотр</a>{% endif %}
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" novalidate id="wo-form">
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="alert alert-danger mb-4"><i class="bi bi-exclamation-triangle me-2"></i>{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="row">
            <!-- ЛЕВАЯ КОЛОНКА -->
            <div class="col-lg-8">
                <!-- Основная информация -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-dark border-0">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2 text-primary"></i>Основная информация</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-semibold">{{ form.name.label }} <span class="text-danger">*</span></label>
                                {{ form.name }}
                                {% if form.name.errors %}<div class="invalid-feedback d-block">{{ form.name.errors }}</div>{% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">{{ form.category.label }}</label>
                                {{ form.category }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">{{ form.priority.label }}</label>
                                {{ form.priority }}
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-semibold">{{ form.description.label }}</label>
                                {{ form.description }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Оборудование и локация -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-dark border-0">
                        <h5 class="mb-0"><i class="bi bi-cpu me-2 text-primary"></i>Оборудование и локация</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">{{ form.location.label }}</label>
                                {{ form.location }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">{{ form.workstation.label }}</label>
                                {{ form.workstation }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Исполнение -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-dark border-0">
                        <h5 class="mb-0"><i class="bi bi-person me-2 text-primary"></i>Исполнение</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-semibold">{{ form.responsible.label }} <span class="text-danger">*</span></label>
                                {{ form.responsible }}
                                {% if form.responsible.errors %}<div class="invalid-feedback d-block">{{ form.responsible.errors }}</div>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Время -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-dark border-0">
                        <h5 class="mb-0"><i class="bi bi-clock me-2 text-primary"></i>Время</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">{{ form.date_start.label }}</label>
                                {{ form.date_start }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">{{ form.date_finish.label }}</label>
                                {{ form.date_finish }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">{{ form.labor_plan_hours.label }}</label>
                                {{ form.labor_plan_hours }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">{{ form.labor_fact_hours.label }}</label>
                                {{ form.labor_fact_hours }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Материалы -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-dark border-0 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-box-seam me-2 text-primary"></i>Материалы</h5>
                        <button type="button" class="btn btn-sm btn-outline-success" id="add-material-btn">
                            <i class="bi bi-plus-lg me-1"></i>Добавить
                        </button>
                    </div>
                    <div class="card-body">
                        {{ formset.management_form }}
                        <div id="materials-container">
                            {% for mat_form in formset %}
                            <div class="material-row mb-3" data-index="{{ forloop.counter0 }}">
                                {{ mat_form.id }}
                                {% for hidden in mat_form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-5">
                                        <label class="form-label small">Материал</label>
                                        <select name="{{ mat_form.material.html_name }}"
                                                class="form-select material-select"
                                                data-material-id="{{ mat_form.instance.material_id|default:'' }}"
                                                data-material-name="{{ mat_form.instance.material.name|default:'' }}">
                                            {% if mat_form.instance.material_id %}
                                            <option value="{{ mat_form.instance.material_id }}" selected>{{ mat_form.instance.material.name }}</option>
                                            {% else %}
                                            <option value="">---------</option>
                                            {% endif %}
                                        </select>
                                        {% if mat_form.material.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in mat_form.material.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">План</label>
                                        {{ mat_form.qty_planned }}
                                        {% if mat_form.qty_planned.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in mat_form.qty_planned.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Факт</label>
                                        {{ mat_form.qty_used }}
                                        {% if mat_form.qty_used.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in mat_form.qty_used.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2 d-none">
                                        {{ mat_form.DELETE }}
                                    </div>
                                    <div class="col-md-3 text-end">
                                        <button type="button" class="btn btn-sm btn-outline-danger material-remove-btn" title="Удалить">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-muted text-center py-3" id="no-materials-msg">
                                <i class="bi bi-inbox me-2"></i>Материалы не добавлены
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Файлы -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-dark border-0">
                        <h5 class="mb-0"><i class="bi bi-paperclip me-2 text-primary"></i>Файлы и вложения</h5>
                    </div>
                    <div class="card-body">
                        <!-- Кнопки загрузки -->
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <label class="btn btn-outline-primary mb-0">
                                <i class="bi bi-upload me-1"></i>Загрузить с устройства
                                <input type="file" id="id_files" name="files" multiple hidden>
                            </label>
                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#filesLibraryModal">
                                <i class="bi bi-folder2-open me-1"></i>Выбрать из библиотеки
                            </button>
                        </div>

                        <!-- Новые файлы -->
                        <div class="mb-3">
                            <div class="small text-muted mb-2">Новые файлы:</div>
                            <ul class="list-group list-group-flush" id="new-files-list"></ul>
                        </div>

                        <!-- Файлы из библиотеки -->
                        <div class="mb-3">
                            <div class="small text-muted mb-2">Выбранные из библиотеки:</div>
                            <ul class="list-group list-group-flush" id="library-selected-list"></ul>
                        </div>

                        <!-- Существующие вложения -->
                        {% if wo.attachments.exists %}
                        <div class="mb-3">
                            <div class="small text-muted mb-2">Существующие вложения:</div>
                            <ul class="list-group list-group-flush" id="existing-files-list">
                                {% for attachment in wo.attachments.all %}
                                <li class="list-group-item d-flex justify-content-between align-items-center file-row" data-file-id="{{ attachment.file.id }}">
                                    <div class="file-thumb-container">
                                        {% with attachment.file.file.url as file_url %}
                                        {% with attachment.file.file.name|cut:"workorders/" as file_name %}
                                        {% if file_url|lower|slice:'-4:' in '.jpg.jpeg.png.gif.webp.bmp.svg' %}
                                        <img src="{{ file_url }}" class="file-thumb" alt="Превью" data-bs-toggle="modal" data-bs-target="#filePreviewModal" data-full-src="{{ file_url }}">
                                        {% else %}
                                        <div class="file-thumb-icon"><i class="bi bi-file-earmark"></i></div>
                                        {% endif %}
                                        <div class="file-info">
                                            <a href="{{ file_url }}" target="_blank" class="d-block text-truncate text-decoration-none" title="{{ file_name }}">{{ file_name }}</a>
                                        </div>
                                        {% endwith %}{% endwith %}
                                    </div>
                                    <div>
                                        <input type="checkbox" name="existing_files" value="{{ attachment.file.id }}" checked class="d-none existing-file-checkbox">
                                        <button type="button" class="btn btn-sm btn-outline-danger existing-file-remove-btn" title="Открепить">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ПРАВАЯ КОЛОНКА -->
            <div class="col-lg-4">
                <div class="sticky-top" style="top: 20px;">
                    <!-- Кнопки -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-check-lg me-2"></i>{% if create %}Создать{% else %}Сохранить{% endif %}
                                </button>
                                <a href="{% if create %}{% url 'maintenance:wo_list' %}{% else %}{% url 'maintenance:wo_detail' object.pk %}{% endif %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-lg me-2"></i>Отмена
                                </a>
                                {% if not create %}
                                <a href="{% url 'maintenance:wo_detail' object.pk %}" class="btn btn-outline-info">
                                    <i class="bi bi-eye me-2"></i>Просмотр задачи
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Шаблон для новой строки материала -->
<template id="material-row-template">
    <div class="material-row mb-3" data-index="__prefix__">
        <div class="row g-2 align-items-end">
            <div class="col-md-5">
                <label class="form-label small">Материал</label>
                <select name="materials-__prefix__-material" class="form-select material-select">
                    <option value="">---------</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small">План</label>
                <input type="number" name="materials-__prefix__-qty_planned" class="form-control" step="0.01" min="0" value="">
            </div>
            <div class="col-md-2">
                <label class="form-label small">Факт</label>
                <input type="number" name="materials-__prefix__-qty_used" class="form-control" step="0.01" min="0" value="">
            </div>
            <div class="col-md-2 d-none">
                <input type="hidden" name="materials-__prefix__-id" value="">
                <input type="checkbox" name="materials-__prefix__-DELETE">
            </div>
            <div class="col-md-3 text-end">
                <button type="button" class="btn btn-sm btn-outline-danger material-remove-btn" title="Удалить">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    </div>
</template>

<!-- Модальное окно библиотеки файлов -->
{% include "includes/_files_library_modal.html" %}

<!-- Модальное окно превью изображений -->
<div class="modal fade" id="filePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-transparent border-0 shadow-none">
            <div class="modal-body p-0 text-center">
                <img id="modalPreviewImage" class="img-fluid rounded" src="" alt="">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const MATERIAL_SEARCH_URL = "{% url 'maintenance:ajax_material_search' %}";

    // =====================================================
    // УТИЛИТЫ
    // =====================================================
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Байт';
        const k = 1024;
        const sizes = ['Байт', 'КБ', 'МБ', 'ГБ'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function isImageFile(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        return ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(ext);
    }

    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const iconMap = { 'pdf': 'bi-file-earmark-pdf', 'doc': 'bi-file-earmark-word', 'docx': 'bi-file-earmark-word', 'xls': 'bi-file-earmark-excel', 'xlsx': 'bi-file-earmark-excel', 'zip': 'bi-file-earmark-zip', 'rar': 'bi-file-earmark-zip' };
        return iconMap[ext] || 'bi-file-earmark';
    }

    // =====================================================
    // TOM SELECT: LOCATION / WORKSTATION / RESPONSIBLE
    // =====================================================
    let locationSelect = null;
    let workstationSelect = null;

    const locationElement = document.querySelector('.js-tom-select-location');
    if (locationElement) {
        locationSelect = new TomSelect(locationElement, {
            maxOptions: null,
            placeholder: 'Выберите локацию...',
            allowEmptyOption: true,
            searchField: ['text'],
            sortField: { field: 'text', direction: 'asc' },
            onChange: function(value) { loadWorkstations(value); }
        });
    }

    const workstationElement = document.querySelector('.js-tom-select-workstation');
    if (workstationElement) {
        workstationSelect = new TomSelect(workstationElement, {
            maxOptions: null,
            placeholder: 'Сначала выберите локацию...',
            allowEmptyOption: true,
            searchField: ['text'],
            sortField: { field: 'text', direction: 'asc' }
        });
        if (!locationSelect || !locationSelect.getValue()) {
            workstationSelect.disable();
        }
    }

    const responsibleElement = document.querySelector('.js-tom-select-responsible');
    if (responsibleElement) {
        new TomSelect(responsibleElement, {
            maxOptions: null,
            placeholder: 'Выберите ответственного...',
            allowEmptyOption: true,
            searchField: ['text'],
            sortField: { field: 'text', direction: 'asc' }
        });
    }

    function loadWorkstations(locationId) {
        if (!workstationSelect) return;
        workstationSelect.clear();
        workstationSelect.clearOptions();
        if (!locationId) {
            workstationSelect.settings.placeholder = 'Сначала выберите локацию...';
            workstationSelect.disable();
            workstationSelect.inputState();
            return;
        }
        workstationSelect.settings.placeholder = 'Загрузка...';
        workstationSelect.disable();
        workstationSelect.inputState();

        fetch('{% url "maintenance:api_workstations" %}?location=' + locationId)
            .then(r => r.json())
            .then(data => {
                if (data && data.length > 0) {
                    data.forEach(item => workstationSelect.addOption({ value: item.id, text: item.name }));
                    workstationSelect.settings.placeholder = 'Выберите оборудование...';
                    workstationSelect.enable();
                } else {
                    workstationSelect.settings.placeholder = 'Нет оборудования';
                    workstationSelect.disable();
                }
                workstationSelect.inputState();
            })
            .catch(() => {
                workstationSelect.settings.placeholder = 'Ошибка загрузки';
                workstationSelect.disable();
                workstationSelect.inputState();
            });
    }

    // При редактировании - загружаем оборудование
    {% if not create and wo.location_id %}
    if (locationSelect && workstationSelect) {
        const currentWorkstation = '{{ wo.workstation_id|default:"" }}';
        fetch('{% url "maintenance:api_workstations" %}?location={{ wo.location_id }}')
            .then(r => r.json())
            .then(data => {
                if (data && data.length > 0) {
                    workstationSelect.clearOptions();
                    data.forEach(item => workstationSelect.addOption({ value: item.id, text: item.name }));
                    if (currentWorkstation) workstationSelect.setValue(currentWorkstation);
                    workstationSelect.enable();
                }
            });
    }
    {% endif %}

    // =====================================================
    // TOM SELECT: МАТЕРИАЛЫ
    // =====================================================
    const materialSelectInstances = new Map();

    function initMaterialSelect(selectEl) {
        if (materialSelectInstances.has(selectEl)) return;
        const initialId = selectEl.dataset.materialId;
        const initialName = selectEl.dataset.materialName;

        const ts = new TomSelect(selectEl, {
            valueField: 'id',
            labelField: 'text',
            searchField: ['text'],
            placeholder: 'Выберите материал...',
            allowEmptyOption: true,
            preload: 'focus',
            load: function(query, callback) {
                fetch(MATERIAL_SEARCH_URL + '?q=' + encodeURIComponent(query || ''))
                    .then(r => r.json())
                    .then(data => callback(data.results || []))
                    .catch(() => callback());
            },
            render: {
                option: (data, escape) => '<div>' + escape(data.text) + (data.article ? ' <small class="text-muted">(' + escape(data.article) + ')</small>' : '') + '</div>',
                item: (data, escape) => '<div>' + escape(data.text) + '</div>'
            }
        });

        if (initialId && initialName) {
            ts.addOption({ id: initialId, text: initialName });
            ts.setValue(initialId);
        }
        materialSelectInstances.set(selectEl, ts);
    }

    document.querySelectorAll('.material-select').forEach(initMaterialSelect);

    // =====================================================
    // FORMSET МАТЕРИАЛОВ
    // =====================================================
    const container = document.getElementById('materials-container');
    const addBtn = document.getElementById('add-material-btn');
    const template = document.getElementById('material-row-template');
    const totalForms = document.querySelector('[name="materials-TOTAL_FORMS"]');
    const noMaterialsMsg = document.getElementById('no-materials-msg');

    function updateFormIndex() {
        if (totalForms) totalForms.value = container.querySelectorAll('.material-row').length;
    }

    function hideNoMaterialsMsg() {
        if (noMaterialsMsg) noMaterialsMsg.style.display = 'none';
    }

    function showNoMaterialsMsgIfEmpty() {
        if (noMaterialsMsg) {
            noMaterialsMsg.style.display = container.querySelectorAll('.material-row:not(.is-removed)').length === 0 ? 'block' : 'none';
        }
    }

    if (addBtn && template) {
        addBtn.addEventListener('click', function() {
            hideNoMaterialsMsg();
            const index = container.querySelectorAll('.material-row').length;
            let html = template.innerHTML.replace(/__prefix__/g, index);
            const div = document.createElement('div');
            div.innerHTML = html;
            const newRow = div.firstElementChild;
            container.appendChild(newRow);
            updateFormIndex();
            const newSelect = newRow.querySelector('.material-select');
            if (newSelect) initMaterialSelect(newSelect);
            attachRemoveHandler(newRow);
        });
    }

    function attachRemoveHandler(row) {
        const btn = row.querySelector('.material-remove-btn');
        if (btn) {
            btn.addEventListener('click', function() {
                const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');
                const idInput = row.querySelector('input[name$="-id"]');

                // Если это существующий материал (есть id) - помечаем на удаление
                if (idInput && idInput.value) {
                    const isRemoved = row.classList.toggle('is-removed');
                    if (deleteCheckbox) deleteCheckbox.checked = isRemoved;

                    // Меняем иконку кнопки
                    btn.innerHTML = isRemoved ? '<i class="bi bi-arrow-counterclockwise"></i>' : '<i class="bi bi-trash"></i>';
                    btn.title = isRemoved ? 'Восстановить' : 'Удалить';
                    btn.classList.toggle('btn-outline-danger', !isRemoved);
                    btn.classList.toggle('btn-outline-success', isRemoved);
                } else {
                    // Новый материал - просто удаляем из DOM
                    const selectEl = row.querySelector('.material-select');
                    if (selectEl && materialSelectInstances.has(selectEl)) {
                        materialSelectInstances.get(selectEl).destroy();
                        materialSelectInstances.delete(selectEl);
                    }
                    row.remove();
                    updateFormIndex();
                }
                showNoMaterialsMsgIfEmpty();
            });
        }
    }

    container.querySelectorAll('.material-row').forEach(attachRemoveHandler);
    showNoMaterialsMsgIfEmpty();

    // =====================================================
    // ФАЙЛЫ: ЗАГРУЗКА С УСТРОЙСТВА
    // =====================================================
    let selectedFiles = [];
    const fileInput = document.getElementById("id_files");
    const newFilesList = document.getElementById("new-files-list");

    if (fileInput && newFilesList) {
        fileInput.addEventListener("change", function(e) {
            Array.from(e.target.files).forEach(file => {
                const isDuplicate = selectedFiles.some(f => f.name === file.name && f.size === file.size);
                if (!isDuplicate) selectedFiles.push(file);
            });
            updateFileInput();
            renderSelectedFiles();
        });

        function renderSelectedFiles() {
            newFilesList.innerHTML = "";
            selectedFiles.forEach((file, index) => {
                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center file-row";
                const isImage = file.type.startsWith('image/');
                const thumbnailUrl = isImage ? URL.createObjectURL(file) : null;

                li.innerHTML = `
                    <div class="file-thumb-container">
                        ${isImage ? `<img class="file-thumb" src="${thumbnailUrl}" alt="Превью">` : `<div class="file-thumb-icon"><i class="bi ${getFileIcon(file.name)}"></i></div>`}
                        <div class="file-info">
                            <span class="d-block text-truncate" title="${file.name}">${file.name}</span>
                            <div class="small text-muted">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger ms-2" data-file-index="${index}"><i class="bi bi-x-lg"></i></button>
                `;
                li.querySelector(`button[data-file-index="${index}"]`).addEventListener("click", () => removeFile(index));
                newFilesList.appendChild(li);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileInput();
            renderSelectedFiles();
        }

        function updateFileInput() {
            const dataTransfer = new DataTransfer();
            selectedFiles.forEach(file => dataTransfer.items.add(file));
            fileInput.files = dataTransfer.files;
        }
    }

    // =====================================================
    // ФАЙЛЫ: БИБЛИОТЕКА
    // =====================================================
    const librarySelectedList = document.getElementById("library-selected-list");
    const filesLibraryModal = document.getElementById("filesLibraryModal");

    function renderLibrarySelectedFiles() {
        if (!librarySelectedList) return;
        const checked = document.querySelectorAll('#filesLibraryModal input[name="existing_files"]:checked');
        librarySelectedList.innerHTML = "";

        checked.forEach(checkbox => {
            const fileName = checkbox.dataset.fileName || `Файл #${checkbox.value}`;
            const fileUrl = checkbox.dataset.fileUrl || '';
            const isImage = isImageFile(fileName);

            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center file-row";
            li.innerHTML = `
                <div class="file-thumb-container">
                    ${isImage ? `<img src="${fileUrl}" class="file-thumb" alt="Превью">` : `<div class="file-thumb-icon"><i class="bi ${getFileIcon(fileName)}"></i></div>`}
                    <div class="file-info">
                        <a href="${fileUrl}" target="_blank" class="d-block text-truncate text-decoration-none" title="${fileName}">${fileName}</a>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger ms-2" data-file-id="${checkbox.value}"><i class="bi bi-x-lg"></i></button>
            `;
            li.querySelector(`button[data-file-id="${checkbox.value}"]`).addEventListener("click", () => {
                checkbox.checked = false;
                renderLibrarySelectedFiles();
            });
            librarySelectedList.appendChild(li);
        });
    }

    if (filesLibraryModal) {
        filesLibraryModal.addEventListener("hidden.bs.modal", renderLibrarySelectedFiles);
    }

    // Поиск в библиотеке
    const fileSearchInput = document.getElementById("fileSearch");
    if (fileSearchInput) {
        fileSearchInput.addEventListener("input", function() {
            const query = this.value.trim().toLowerCase();
            document.querySelectorAll('#filesLibraryModal label.list-group-item').forEach(label => {
                const checkbox = label.querySelector('input[type="checkbox"]');
                const fileName = (checkbox?.dataset.fileName || "").toLowerCase();
                label.style.display = !query || fileName.includes(query) ? "" : "none";
            });
        });
    }

    // =====================================================
    // ФАЙЛЫ: СУЩЕСТВУЮЩИЕ ВЛОЖЕНИЯ
    // =====================================================
    document.querySelectorAll('.existing-file-remove-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const row = this.closest('.file-row');
            const checkbox = row.querySelector('.existing-file-checkbox');
            const isRemoved = row.classList.toggle('is-removed');

            checkbox.checked = !isRemoved;
            this.innerHTML = isRemoved ? '<i class="bi bi-arrow-counterclockwise"></i>' : '<i class="bi bi-trash"></i>';
            this.title = isRemoved ? 'Восстановить' : 'Открепить';
            this.classList.toggle('btn-outline-danger', !isRemoved);
            this.classList.toggle('btn-outline-success', isRemoved);
        });
    });

    // =====================================================
    // ПРЕВЬЮ ИЗОБРАЖЕНИЙ
    // =====================================================
    const filePreviewModal = document.getElementById('filePreviewModal');
    if (filePreviewModal) {
        filePreviewModal.addEventListener('show.bs.modal', function(e) {
            const src = e.relatedTarget.getAttribute('data-full-src');
            document.getElementById('modalPreviewImage').src = src;
        });
        filePreviewModal.addEventListener('hidden.bs.modal', function() {
            document.getElementById('modalPreviewImage').src = '';
        });
    }
});
</script>
{% endblock %}
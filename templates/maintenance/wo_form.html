{% extends "base.html" %}
{% load form_extras %}

{% block title %}
{% if create %}–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ #{{ wo.pk }}{% endif %}
{% endblock %}

{% block content %}
<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–≤—å—é —Ñ–∞–π–ª–æ–≤ */
.file-thumb-container {
    display: flex;
    align-items: center;
    gap: 12px;
}

.file-thumb {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
    cursor: zoom-in;
    border: 1px solid var(--bs-border-color);
    transition: transform .15s ease, box-shadow .15s ease;
}

.file-thumb:hover {
    transform: scale(1.02);
    box-shadow: 0 .25rem .75rem rgba(0, 0, 0, .15);
}

.file-thumb-icon {
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--bs-secondary-color);
    font-size: 32px;
    border-radius: 6px;
    border: 1px solid var(--bs-border-color);
}

.file-info {
    flex: 1;
    min-width: 0;
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
.modal-content.bg-transparent {
    background: transparent;
}
</style>

<div class="row justify-content-center">
    <div class="col-xl-8 col-lg-9">

        <div class="card shadow-sm border-0">
            <div class="card-body">

                <!-- ===== Header ===== -->
                <div class="mb-4">
                    <h1 class="h4 mb-1">
                        {% if create %}–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ #{{ wo.pk }}{% endif %}
                    </h1>
                    <div class="text-muted small">
                        –†–∞–±–æ—Ç—ã ¬∑ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
                    </div>
                </div>

                <form id="wo-form" method="post" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    {{ form.non_field_errors }}

                    <!-- ===============================
                         1. –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                         =============================== -->
                    <div class="mb-4">
                        <div class="section-header mb-3">1. –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>

                        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold required">
                                {{ form.name.label }}
                            </label>
                            {{ form.name|add_class:"form-control" }}
                            {% for e in form.name.errors %}
                            <div class="text-danger small mt-1">{{ e }}</div>
                            {% endfor %}
                        </div>

                        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold required">
                                {{ form.category.label }}
                            </label>
                            {{ form.category|add_class:"form-select" }}
                            {% for e in form.category.errors %}
                            <div class="text-danger small mt-1">{{ e }}</div>
                            {% endfor %}
                        </div>

                        <!-- –õ–æ–∫–∞—Ü–∏—è -->
                        {% if form.location %}
                        <div class="mb-3">
                            <label class="form-label fw-semibold {% if form.location.field.required %}required{% endif %}">
                                {{ form.location.label }}
                            </label>
                            {{ form.location|add_class:"form-select" }}
                            {% for e in form.location.errors %}
                            <div class="text-danger small mt-1">{{ e }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ -->
                        {% if form.workstation %}
                        <div class="mb-3">
                            <label class="form-label fw-semibold {% if form.workstation.field.required %}required{% endif %}">
                                {{ form.workstation.label }}
                            </label>
                            {{ form.workstation|add_class:"form-select" }}
                            {% for e in form.workstation.errors %}
                            <div class="text-danger small mt-1">{{ e }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                {{ form.description.label }}
                            </label>
                            {{ form.description|add_class:"form-control" }}
                        </div>

                        <!-- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold required">
                                {{ form.priority.label }}
                            </label>
                            {{ form.priority|add_class:"form-select" }}
                            {% for e in form.priority.errors %}
                            <div class="text-danger small mt-1">{{ e }}</div>
                            {% endfor %}
                        </div>

                        <!-- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold required">
                                {{ form.responsible.label }}
                            </label>
                            {{ form.responsible|add_class:"form-select" }}
                            {% for e in form.responsible.errors %}
                            <div class="text-danger small mt-1">{{ e }}</div>
                            {% endfor %}
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <!-- –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ -->
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">
                                        {{ form.date_start.label }}
                                    </label>
                                    {{ form.date_start|add_class:"form-control" }}
                                    {% for e in form.date_start.errors %}
                                    <div class="text-danger small mt-1">{{ e }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è -->
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">
                                        {{ form.date_finish.label }}
                                    </label>
                                    {{ form.date_finish|add_class:"form-control" }}
                                    {% for e in form.date_finish.errors %}
                                    <div class="text-danger small mt-1">{{ e }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <!-- –¢—Ä—É–¥–æ—ë–º–∫–æ—Å—Ç—å (–ø–ª–∞–Ω) -->
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">
                                        {{ form.labor_plan_hours.label }}
                                    </label>
                                    {{ form.labor_plan_hours|add_class:"form-control" }}
                                    {% for e in form.labor_plan_hours.errors %}
                                    <div class="text-danger small mt-1">{{ e }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- –¢—Ä—É–¥–æ—ë–º–∫–æ—Å—Ç—å (—Ñ–∞–∫—Ç) -->
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">
                                        {{ form.labor_fact_hours.label }}
                                    </label>
                                    {{ form.labor_fact_hours|add_class:"form-control" }}
                                    {% for e in form.labor_fact_hours.errors %}
                                    <div class="text-danger small mt-1">{{ e }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===============================
                         –§–∞–π–ª—ã
                         =============================== -->
                    <div class="mb-4">
                        <div class="section-header mb-3">–§–∞–π–ª—ã</div>

                        <!-- Actions -->
                        <div class="d-flex flex-wrap gap-2 mb-3">

                            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
                            <label class="btn btn-outline-primary mb-0">
                                <i class="bi bi-upload"></i>
                                –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                                <input
                                        type="file"
                                        id="id_files"
                                        name="files"
                                        multiple
                                        hidden
                                >
                            </label>

                            <!-- –û—Ç–∫—Ä—ã—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Ñ–∞–π–ª–æ–≤ -->
                            <button
                                    type="button"
                                    class="btn btn-outline-secondary"
                                    data-bs-toggle="modal"
                                    data-bs-target="#filesLibraryModal"
                            >
                                <i class="bi bi-folder2-open"></i>
                                –í—ã–±—Ä–∞—Ç—å –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
                            </button>

                        </div>

                        <!-- –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã (—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, JS) -->
                        <ul class="list-group list-group-flush mb-2" id="new-files-list">
                            <!-- –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
                        </ul>

                        <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (–¥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è) -->
                        <ul class="list-group list-group-flush mb-2" id="library-selected-list">
                        </ul>

                        <!-- –£–∂–µ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã -->
                        <ul class="list-group list-group-flush mt-2">
                            {% if wo.attachments.exists %}
                            {% for att in wo.attachments.all %}
                            <li class="list-group-item d-flex justify-content-between align-items-center file-row">
                                <div class="file-thumb-container">
                                    {% with att.file.file.url as file_url %}
                                    {% with att.file.file.name|cut:"workorders/" as file_name %}
                                    {% if file_url|lower|slice:'-4:' in '.jpg,.jpeg,.png,.gif,.webp,.bmp,.svg' %}
                                    <img src="{{ file_url }}"
                                         class="file-thumb"
                                         alt="–ü—Ä–µ–≤—å—é"
                                         data-bs-toggle="modal"
                                         data-bs-target="#filePreviewModal"
                                         data-full-src="{{ file_url }}">
                                    {% else %}
                                    <div class="file-thumb-icon">
                                        <i class="bi bi-file-earmark"></i>
                                    </div>
                                    {% endif %}

                                    <div class="file-info">
                                        <a href="{{ file_url }}"
                                           target="_blank"
                                           class="d-block text-truncate text-decoration-none"
                                           title="{{ file_name }}">
                                            {{ file_name }}
                                        </a>
                                        <div class="small text-muted">
                                            {{ att.file.file.size|filesizeformat }}
                                        </div>
                                    </div>
                                    {% endwith %}
                                    {% endwith %}
                                </div>

                                <!-- –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã -->
                                <input type="hidden" name="existing_files" value="{{ att.file.id }}">

                                <button type="button"
                                        class="btn btn-sm btn-outline-danger file-remove-btn ms-2"
                                        title="–û—Ç–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </li>
                            {% endfor %}
                            {% else %}
                            <li class="list-group-item text-muted small">
                                –§–∞–π–ª—ã –ø–æ–∫–∞ –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã
                            </li>
                            {% endif %}
                        </ul>
                    </div>

                    <!-- ===============================
                         2. –ú–∞—Ç–µ—Ä–∏–∞–ª—ã
                         =============================== -->
                    <div class="mb-4">
                        <div class="section-header mb-3">2. –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</div>

                        {{ formset.management_form }}

                        <div id="materials-container">
                            {% for f in formset %}
                            <div class="material-row rounded-3 p-3 mb-3 bg-body-tertiary position-relative">

                                {% for hf in f.hidden_fields %}{{ hf }}{% endfor %}

                                <button type="button"
                                        class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2 material-remove-btn">
                                    <i class="bi bi-trash"></i>
                                </button>

                                <div class="d-none">{{ f.DELETE }}</div>

                                <div class="mb-2">
                                    <label class="form-label fw-semibold">{{ f.material.label }}</label>
                                    {{ f.material|add_class:"form-select js-select2" }}
                                    {% for e in f.material.errors %}
                                    <div class="text-danger small mt-1">{{ e }}</div>
                                    {% endfor %}
                                </div>

                                <div class="row g-2">
                                    <div class="col">
                                        <label class="form-label fw-semibold">{{ f.qty_planned.label }}</label>
                                        {{ f.qty_planned|add_class:"form-control" }}
                                        {% for e in f.qty_planned.errors %}
                                        <div class="text-danger small mt-1">{{ e }}</div>
                                        {% endfor %}
                                    </div>
                                    <div class="col">
                                        <label class="form-label fw-semibold">{{ f.qty_used.label }}</label>
                                        {{ f.qty_used|add_class:"form-control" }}
                                        {% for e in f.qty_used.errors %}
                                        <div class="text-danger small mt-1">{{ e }}</div>
                                        {% endfor %}
                                    </div>
                                </div>

                            </div>
                            {% endfor %}
                        </div>

                        <button type="button" class="btn btn-outline-primary" id="add-material">
                            <i class="bi bi-plus-lg"></i> –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
                        </button>

                        <!-- empty form template -->
                        <template id="material-template">
                            <div class="material-row rounded-3 p-3 mb-3 bg-body-tertiary position-relative">

                                {% for hf in formset.empty_form.hidden_fields %}{{ hf }}{% endfor %}

                                <button type="button"
                                        class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2 material-remove-btn">
                                    <i class="bi bi-trash"></i>
                                </button>

                                <div class="d-none">{{ formset.empty_form.DELETE }}</div>

                                <div class="mb-2">
                                    <label class="form-label fw-semibold">
                                        {{ formset.empty_form.material.label }}
                                    </label>
                                    {{ formset.empty_form.material|add_class:"form-select js-select2" }}
                                </div>

                                <div class="row g-2">
                                    <div class="col">
                                        <label class="form-label fw-semibold">
                                            {{ formset.empty_form.qty_planned.label }}
                                        </label>
                                        {{ formset.empty_form.qty_planned|add_class:"form-control" }}
                                    </div>
                                    <div class="col">
                                        <label class="form-label fw-semibold">
                                            {{ formset.empty_form.qty_used.label }}
                                        </label>
                                        {{ formset.empty_form.qty_used|add_class:"form-control" }}
                                    </div>
                                </div>

                            </div>
                        </template>
                    </div>

                    <!-- ===============================
                         Actions
                         =============================== -->
                    <div class="d-flex justify-content-between mt-4">
                        <a class="btn btn-outline-secondary" href="{% url 'maintenance:wo_list' %}">
                            –û—Ç–º–µ–Ω–∞
                        </a>
                        <button class="btn btn-primary px-4" type="submit">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </form>
                {% include "includes/_files_library_modal.html" %}
            </div>
        </div>

    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
<div class="modal fade" id="filePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-transparent border-0 shadow-none">
            <div class="modal-body p-0 text-center">
                <img id="modalPreviewImage" class="img-fluid rounded" src="" alt="">
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // =====================================================
        // FILE LIBRARY: show selected (UI only), without saving
        // =====================================================
        const selectedList = document.getElementById("library-selected-list");
        const modalEl = document.getElementById("filesLibraryModal");

        function renderSelectedFromLibrary() {
            const list = document.getElementById("library-selected-list");
            if (!list) return;

            const checked = Array.from(
                document.querySelectorAll(
                    '#filesLibraryModal input[name="existing_files"]:checked'
                )
            );

            list.innerHTML = "";
            if (checked.length === 0) return;

            checked.forEach(cb => {
                const name = cb.dataset.fileName || `–§–∞–π–ª #${cb.value}`;
                const url = cb.dataset.fileUrl;
                const size = cb.dataset.fileSize || '';

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
                const isImage = /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(name);

                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center file-row";

                li.innerHTML = `
                    <div class="file-thumb-container">
                        ${isImage ?
                            `<img src="${url}"
                                  class="file-thumb"
                                  alt="–ü—Ä–µ–≤—å—é"
                                  data-bs-toggle="modal"
                                  data-bs-target="#filePreviewModal"
                                  data-full-src="${url}">` :
                            `<div class="file-thumb-icon">
                                <i class="bi bi-file-earmark"></i>
                             </div>`
                        }
                        <div class="file-info">
                            <a href="${url}"
                               target="_blank"
                               class="d-block text-truncate text-decoration-none"
                               title="${name}">
                                ${name}
                            </a>
                            ${size ? `<div class="small text-muted">${size}</div>` : ''}
                        </div>
                    </div>
                    <button type="button"
                            class="btn btn-sm btn-outline-danger ms-2"
                            title="–£–±—Ä–∞—Ç—å">
                        <i class="bi bi-x-lg"></i>
                    </button>
                `;

                li.querySelector("button").addEventListener("click", () => {
                    cb.checked = false;
                    renderSelectedFromLibrary();
                });

                list.appendChild(li);
            });
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏
        if (modalEl) {
            modalEl.addEventListener("hidden.bs.modal", renderSelectedFromLibrary);
        }

        // =====================================================
        // FILES: add / preview / remove before submit
        // =====================================================
        const input = document.getElementById("id_files");
        const list = document.getElementById("new-files-list");

        // üîë –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
        let selectedFiles = [];

        if (input && list) {
            input.addEventListener("change", () => {
                const newlySelected = Array.from(input.files);

                newlySelected.forEach(file => {
                    // –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π (–æ–¥–Ω–æ –∏–º—è + —Ä–∞–∑–º–µ—Ä)
                    const exists = selectedFiles.some(
                        f => f.name === file.name && f.size === file.size
                    );
                    if (!exists) {
                        selectedFiles.push(file);
                    }
                });

                syncInputFiles();
                renderFiles();
            });

            function renderFiles() {
                list.innerHTML = "";

                selectedFiles.forEach((file, index) => {
                    const li = document.createElement("li");
                    li.className = "list-group-item d-flex justify-content-between align-items-center file-row";

                    // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–≤—å—é –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                    let previewContent = '';
                    let isImage = false;
                    if (file.type.startsWith('image/')) {
                        isImage = true;
                        const url = URL.createObjectURL(file);
                        previewContent = `
                            <img class="file-thumb"
                                 src="${url}"
                                 alt="–ü—Ä–µ–≤—å—é"
                                 data-bs-toggle="modal"
                                 data-bs-target="#filePreviewModal"
                                 data-full-src="${url}"
                                 data-blob="true">
                        `;
                    } else {
                        previewContent = `
                            <div class="file-thumb-icon">
                                <i class="bi bi-file-earmark"></i>
                            </div>
                        `;
                    }

                    li.innerHTML = `
                        <div class="file-thumb-container">
                            ${previewContent}
                            <div class="file-info">
                                <span class="d-block text-truncate" title="${file.name}">
                                    ${file.name}
                                </span>
                                <div class="small text-muted">
                                    ${formatFileSize(file.size)}
                                </div>
                            </div>
                        </div>
                        <button type="button"
                                class="btn btn-sm btn-outline-danger ms-2"
                                title="–£–±—Ä–∞—Ç—å —Ñ–∞–π–ª">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    `;

                    const removeBtn = li.querySelector("button");
                    removeBtn.addEventListener("click", () => {
                        // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º Blob URL –µ—Å–ª–∏ –æ–Ω –±—ã–ª —Å–æ–∑–¥–∞–Ω
                        const img = li.querySelector('img[data-blob="true"]');
                        if (img) {
                            URL.revokeObjectURL(img.src);
                        }
                        selectedFiles.splice(index, 1);
                        syncInputFiles();
                        renderFiles();
                    });

                    list.appendChild(li);
                });
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function syncInputFiles() {
                const dt = new DataTransfer();
                selectedFiles.forEach(f => dt.items.add(f));
                input.files = dt.files;
            }
        }

        // =====================================================
        // –ü–æ–∏—Å–∫ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ —Ñ–∞–π–ª–æ–≤
        // =====================================================
        const search = document.getElementById("fileSearch");
        if (search) {
            search.addEventListener("input", function () {
                const q = this.value.trim().toLowerCase();

                document
                    .querySelectorAll('#filesLibraryModal label.list-group-item')
                    .forEach(label => {
                        const checkbox = label.querySelector('input[type="checkbox"]');
                        const span = label.querySelector('span');
                        const name = checkbox?.dataset.fileName || "";

                        // —Å–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                        span.innerHTML = name;

                        if (!q) {
                            label.style.display = "";
                            return;
                        }

                        const nameLower = name.toLowerCase();

                        if (!nameLower.includes(q)) {
                            label.style.display = "none";
                            return;
                        }

                        // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
                        const start = nameLower.indexOf(q);
                        const end = start + q.length;

                        span.innerHTML =
                            name.slice(0, start) +
                            "<mark>" +
                            name.slice(start, end) +
                            "</mark>" +
                            name.slice(end);

                        label.style.display = "";
                    });
            });
        }

        // =====================================================
        // FILES: mark for detach (UI only, like materials)
        // =====================================================
        document.addEventListener("click", function (e) {
            const btn = e.target.closest(".file-remove-btn");
            if (!btn) return;

            const row = btn.closest(".file-row");
            const input = row.querySelector('input[name="existing_files"]');

            const isRemoved = row.classList.toggle("is-removed");

            if (isRemoved) {
                // –ø–æ–º–µ—á–∞–µ–º –∫ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–∏—é
                input.disabled = true;
            } else {
                // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–∞–π–ª
                input.disabled = false;
            }
        });

        // =====================================================
        // Select2 –¥–ª—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ + –∫–∞—Ä—Ç–∏–Ω–∫–∏
        // =====================================================
        function formatMaterial(option) {
            if (!option.id) return option.text;

            const img = option.element?.dataset?.image;
            if (!img) return option.text;

            return $(`
                <span class="d-flex align-items-center gap-2">
                    <img src="${img}"
                         class="rounded border"
                         style="width:24px;height:24px;object-fit:cover">
                    <span>${option.text}</span>
                </span>
            `);
        }

        function initSelect2(ctx) {
            $(ctx).find(".js-select2").each(function () {
                if ($(this).hasClass("select2-hidden-accessible")) return;

                $(this).select2({
                    width: "100%",
                    allowClear: true,
                    placeholder: "–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª",
                    templateResult: formatMaterial,
                    templateSelection: formatMaterial,
                    escapeMarkup: m => m
                });
            });
        }

        initSelect2(document);

        // =====================================================
        // –£–¥–∞–ª–µ–Ω–∏–µ / –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (formset DELETE)
        // =====================================================
        document.addEventListener("click", function (e) {
            const btn = e.target.closest(".material-remove-btn");
            if (!btn) return;

            const row = btn.closest(".material-row");
            const del = row.querySelector('input[type="checkbox"][name$="-DELETE"]');

            del.checked = !del.checked;
            row.classList.toggle("opacity-50", del.checked);

            $(row)
                .find("select, input:not([type='hidden'])")
                .not('[name$="-DELETE"]')
                .prop("disabled", del.checked)
                .trigger("change");
        });

        // =====================================================
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (formset)
        // =====================================================
        const container = document.getElementById("materials-container");
        const addBtn = document.getElementById("add-material");
        const template = document.getElementById("material-template");

        if (container && addBtn && template) {
            const prefix = "{{ formset.prefix }}";
            const totalForms = document.querySelector(
                `input[name="${prefix}-TOTAL_FORMS"]`
            );
            let index = parseInt(totalForms.value, 10);

            addBtn.addEventListener("click", function () {
                const clone = document.importNode(template.content, true);

                clone.querySelectorAll("[name],[id],[for]").forEach(el => {
                    ["name", "id", "for"].forEach(attr => {
                        if (el.hasAttribute(attr)) {
                            el.setAttribute(
                                attr,
                                el.getAttribute(attr).replace(/__prefix__/g, index)
                            );
                        }
                    });
                });

                container.appendChild(clone);
                initSelect2(container.lastElementChild);
                totalForms.value = index + 1;
                index += 1;
            });
        }

        // =====================================================
        // LOCATION ‚Üí WORKSTATION
        // =====================================================
        const $location = $("#id_location");
        const $workstation = $("#id_workstation");

        if ($location.length && $workstation.length) {
            $location.select2({width: "100%"});
            $workstation.select2({
                width: "100%",
                allowClear: true,
                placeholder: "–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
            });

            const WS_URL = "{% url 'maintenance:ajax_workstations_by_location' %}";
            const initialWorkstation = $workstation.val();

            function lockWorkstations(clear = true) {
                if (clear) {
                    $workstation.val(null).trigger("change");
                }
                $workstation.prop("disabled", true);
            }

            function unlockWorkstations() {
                $workstation.prop("disabled", false);
            }

            function loadWorkstations(locationId, restoreValue = null) {
                lockWorkstations(true);
                if (!locationId) return;

                fetch(`${WS_URL}?location_id=${locationId}`, {
                    headers: {"X-Requested-With": "XMLHttpRequest"}
                })
                    .then(r => r.json())
                    .then(data => {
                        if (!data.ok || !data.items.length) {
                            lockWorkstations(true);
                            return;
                        }

                        $workstation.empty().append(new Option("", "", false, false));

                        data.items.forEach(item => {
                            const selected = restoreValue && item.id == restoreValue;
                            $workstation.append(
                                new Option(item.text, item.id, selected, selected)
                            );
                        });

                        unlockWorkstations();
                        $workstation.trigger("change");
                    })
                    .catch(() => lockWorkstations(true));
            }

            $location.on("change", function () {
                loadWorkstations(this.value, null);
            });

            if ($location.val()) {
                loadWorkstations($location.val(), initialWorkstation);
            } else {
                lockWorkstations(true);
            }
        }

        // =====================================================
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        // =====================================================
        const filePreviewModal = document.getElementById('filePreviewModal');
        if (filePreviewModal) {
            filePreviewModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const fullSrc = button.getAttribute('data-full-src');
                const modalImage = document.getElementById('modalPreviewImage');
                modalImage.src = fullSrc;
            });

            filePreviewModal.addEventListener('hidden.bs.modal', function () {
                const modalImage = document.getElementById('modalPreviewImage');
                modalImage.src = '';
            });
        }

        // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º Blob URL –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function () {
            document.querySelectorAll('img[data-blob="true"]').forEach(img => {
                URL.revokeObjectURL(img.src);
            });
        });

        // –¢–∞–∫–∂–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º Blob URL –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
        const form = document.getElementById('wo-form');
        if (form) {
            form.addEventListener('submit', function () {
                document.querySelectorAll('img[data-blob="true"]').forEach(img => {
                    URL.revokeObjectURL(img.src);
                });
            });
        }
    });
</script>
{% endblock %}
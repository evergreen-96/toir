{% extends "base.html" %}
{% load form_extras %}

{% block title %}
{% if create %}–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ #{{ wo.pk }}{% endif %}
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-xl-8 col-lg-9">

        <div class="card shadow-sm border-0">
            <div class="card-body">

                <!-- ===== Header ===== -->
                <div class="mb-4">
                    <h1 class="h4 mb-1">
                        {% if create %}–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ #{{ wo.pk }}{% endif %}
                    </h1>
                    <div class="text-muted small">
                        –†–∞–±–æ—Ç—ã ¬∑ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
                    </div>
                </div>

                <form method="post" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    {{ form.non_field_errors }}
                    {% if form.errors %}
                    <pre class="bg-light p-3 small text-danger">
{{ form.errors }}
</pre>
                    {% endif %}
                    <!-- ===============================
                         1. –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                         =============================== -->
                    <div class="form-section">
                        <div class="form-section-header">
                            1. –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                        </div>

                        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold required">
                                {{ form.name.label }}
                            </label>
                            {{ form.name|add_class:"form-control" }}
                            {% for e in form.name.errors %}
                            <div class="text-danger small mt-1">{{ e }}</div>
                            {% endfor %}
                        </div>

                        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold required">
                                {{ form.category.label }}
                            </label>
                            {{ form.category|add_class:"form-select" }}
                            {% for e in form.category.errors %}
                            <div class="text-danger small mt-1">{{ e }}</div>
                            {% endfor %}
                        </div>

                        <!-- –õ–æ–∫–∞—Ü–∏—è -->
                        {% if form.location %}
                        <div class="mb-3">
                            <label class="form-label fw-semibold {% if form.location.field.required %}required{% endif %}">
                                {{ form.location.label }}
                            </label>
                            {{ form.location|add_class:"form-select" }}
                            {% for e in form.location.errors %}
                            <div class="text-danger small mt-1">{{ e }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ -->
                        {% if form.workstation %}
                        <div class="mb-3">
                            <label class="form-label fw-semibold {% if form.workstation.field.required %}required{% endif %}">
                                {{ form.workstation.label }}
                            </label>
                            {{ form.workstation|add_class:"form-select" }}
                            {% for e in form.workstation.errors %}
                            <div class="text-danger small mt-1">{{ e }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                {{ form.description.label }}
                            </label>
                            {{ form.description|add_class:"form-control" }}
                        </div>

                        <!-- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold required">
                                {{ form.priority.label }}
                            </label>
                            {{ form.priority|add_class:"form-select" }}
                            {% for e in form.priority.errors %}
                            <div class="text-danger small mt-1">{{ e }}</div>
                            {% endfor %}
                        </div>

                        <!-- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold required">
                                {{ form.responsible.label }}
                            </label>
                            {{ form.responsible|add_class:"form-select" }}
                            {% for e in form.responsible.errors %}
                            <div class="text-danger small mt-1">{{ e }}</div>
                            {% endfor %}
                        </div>

                        <!-- –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                {{ form.date_start.label }}
                            </label>
                            {{ form.date_start|add_class:"form-control" }}
                            {% for e in form.date_start.errors %}
                            <div class="text-danger small mt-1">{{ e }}</div>
                            {% endfor %}
                        </div>

                        <!-- –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                {{ form.date_finish.label }}
                            </label>
                            {{ form.date_finish|add_class:"form-control" }}
                            {% for e in form.date_finish.errors %}
                            <div class="text-danger small mt-1">{{ e }}</div>
                            {% endfor %}
                        </div>

                        <!-- –¢—Ä—É–¥–æ—ë–º–∫–æ—Å—Ç—å (–ø–ª–∞–Ω) -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                {{ form.labor_plan_hours.label }}
                            </label>
                            {{ form.labor_plan_hours|add_class:"form-control" }}
                            {% for e in form.labor_plan_hours.errors %}
                            <div class="text-danger small mt-1">{{ e }}</div>
                            {% endfor %}
                        </div>

                        <!-- –¢—Ä—É–¥–æ—ë–º–∫–æ—Å—Ç—å (—Ñ–∞–∫—Ç) -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                {{ form.labor_fact_hours.label }}
                            </label>
                            {{ form.labor_fact_hours|add_class:"form-control" }}
                            {% for e in form.labor_fact_hours.errors %}
                            <div class="text-danger small mt-1">{{ e }}</div>
                            {% endfor %}
                        </div>

                        <!-- ===============================
                           –§–∞–π–ª—ã
                           =============================== -->
                        <div class="form-section">
                            <div class="form-section-header">
                                –§–∞–π–ª—ã
                            </div>

                            <!-- input -->
                            <input
                                    type="file"
                                    id="id_files"
                                    name="files"
                                    multiple
                                    class="form-control"
                            />

                            <!-- preview –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
                            <ul class="list-group list-group-flush mt-2" id="new-files-list"></ul>

                            <!-- —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã -->
                            {% if wo and wo.attachments.exists %}
                            <div class="mt-3">
                                <div class="text-muted small mb-1">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</div>
                                <ul class="list-group list-group-flush">
                                    {% for f in wo.attachments.all %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <a href="{{ f.file.url }}" target="_blank">
                                            {{ f.file.name|cut:"workorders/" }}
                                        </a>
                                        <button
                                                type="button"
                                                class="btn btn-sm btn-outline-danger"
                                                data-file-id="{{ f.pk }}"
                                                title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª"
                                        >
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>


                    </div>

                    <!-- ===============================
                         2. –ú–∞—Ç–µ—Ä–∏–∞–ª—ã
                         =============================== -->
                    <div class="form-section">
                        <div class="form-section-header">
                            2. –ú–∞—Ç–µ—Ä–∏–∞–ª—ã
                        </div>

                        {{ formset.management_form }}

                        <div id="materials-container">
                            {% for f in formset %}
                            <div class="material-row rounded-3 p-3 mb-3 bg-body-tertiary position-relative">

                                {% for hf in f.hidden_fields %}{{ hf }}{% endfor %}

                                <button type="button"
                                        class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2 material-remove-btn">
                                    <i class="bi bi-trash"></i>
                                </button>

                                <div class="d-none">{{ f.DELETE }}</div>

                                <div class="mb-2">
                                    <label class="form-label fw-semibold">{{ f.material.label }}</label>
                                    {{ f.material|add_class:"form-select js-select2" }}
                                    {% for e in f.material.errors %}
                                    <div class="text-danger small mt-1">{{ e }}</div>
                                    {% endfor %}
                                </div>

                                <div class="row g-2">
                                    <div class="col">
                                        <label class="form-label fw-semibold">{{ f.qty_planned.label }}</label>
                                        {{ f.qty_planned|add_class:"form-control" }}
                                        {% for e in f.qty_planned.errors %}
                                        <div class="text-danger small mt-1">{{ e }}</div>
                                        {% endfor %}
                                    </div>
                                    <div class="col">
                                        <label class="form-label fw-semibold">{{ f.qty_used.label }}</label>
                                        {{ f.qty_used|add_class:"form-control" }}
                                        {% for e in f.qty_used.errors %}
                                        <div class="text-danger small mt-1">{{ e }}</div>
                                        {% endfor %}
                                    </div>
                                </div>

                            </div>
                            {% endfor %}
                        </div>

                        <button type="button" class="btn btn-outline-primary" id="add-material">
                            <i class="bi bi-plus-lg"></i> –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
                        </button>

                        <!-- empty form template -->
                        <template id="material-template">
                            <div class="material-row rounded-3 p-3 mb-3 bg-body-tertiary position-relative">

                                {% for hf in formset.empty_form.hidden_fields %}{{ hf }}{% endfor %}

                                <button type="button"
                                        class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2 material-remove-btn">
                                    <i class="bi bi-trash"></i>
                                </button>

                                <div class="d-none">{{ formset.empty_form.DELETE }}</div>

                                <div class="mb-2">
                                    <label class="form-label fw-semibold">
                                        {{ formset.empty_form.material.label }}
                                    </label>
                                    {{ formset.empty_form.material|add_class:"form-select js-select2" }}
                                </div>

                                <div class="row g-2">
                                    <div class="col">
                                        <label class="form-label fw-semibold">
                                            {{ formset.empty_form.qty_planned.label }}
                                        </label>
                                        {{ formset.empty_form.qty_planned|add_class:"form-control" }}
                                    </div>
                                    <div class="col">
                                        <label class="form-label fw-semibold">
                                            {{ formset.empty_form.qty_used.label }}
                                        </label>
                                        {{ formset.empty_form.qty_used|add_class:"form-control" }}
                                    </div>
                                </div>

                            </div>
                        </template>
                    </div>

                    <!-- ===============================
                         Actions
                         =============================== -->
                    <div class="d-flex justify-content-between mt-4">
                        <a class="btn btn-outline-secondary" href="{% url 'maintenance:wo_list' %}">
                            –û—Ç–º–µ–Ω–∞
                        </a>
                        <button class="btn btn-primary px-4" type="submit">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>

                </form>

            </div>
        </div>

    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    // =====================================================
    // FILES: add / preview / remove before submit
    // =====================================================
    const input = document.getElementById("id_files");
    const list = document.getElementById("new-files-list");

    // üîë –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
    let selectedFiles = [];

    if (input && list) {

        input.addEventListener("change", () => {
            const newlySelected = Array.from(input.files);

            newlySelected.forEach(file => {
                // –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π (–æ–¥–Ω–æ –∏–º—è + —Ä–∞–∑–º–µ—Ä)
                const exists = selectedFiles.some(
                    f => f.name === file.name && f.size === file.size
                );
                if (!exists) {
                    selectedFiles.push(file);
                }
            });

            syncInputFiles();
            renderFiles();
        });

        function renderFiles() {
            list.innerHTML = "";

            selectedFiles.forEach((file, index) => {
                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center";

                li.innerHTML = `
                    <span class="text-truncate">${file.name}</span>
                    <button type="button"
                            class="btn btn-sm btn-outline-danger"
                            title="–£–±—Ä–∞—Ç—å —Ñ–∞–π–ª">
                        <i class="bi bi-x-lg"></i>
                    </button>
                `;

                li.querySelector("button").addEventListener("click", () => {
                    selectedFiles.splice(index, 1);
                    syncInputFiles();
                    renderFiles();
                });

                list.appendChild(li);
            });
        }

        function syncInputFiles() {
            const dt = new DataTransfer();
            selectedFiles.forEach(f => dt.items.add(f));
            input.files = dt.files;
        }
    }

    // =====================================================
    // FILES: delete already uploaded (AJAX)
    // =====================================================
    document.querySelectorAll("[data-file-id]").forEach(btn => {
        btn.addEventListener("click", () => {
            if (!confirm("–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?")) return;

            const fileId = btn.dataset.fileId;

            fetch(
                `{% url 'maintenance:wo_file_delete' 0 %}`.replace("/0/", `/${fileId}/`),
                {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                    }
                }
            )
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    btn.closest("li").remove();
                }
            });
        });
    });

    // =====================================================
    // Select2 –¥–ª—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
    // =====================================================
    function initSelect2(ctx) {
        $(ctx).find(".js-select2").select2({
            width: "100%",
            allowClear: true,
            placeholder: "–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª"
        });
    }

    initSelect2(document);

    // =====================================================
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ / —É–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (formset)
    // =====================================================
    document.addEventListener("click", function (e) {
        const btn = e.target.closest(".material-remove-btn");
        if (!btn) return;

        const row = btn.closest(".material-row");
        const del = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
        del.checked = !del.checked;

        $(row).find("select, input").prop("disabled", del.checked);
    });

    const container = document.getElementById("materials-container");
    const addBtn = document.getElementById("add-material");
    const template = document.getElementById("material-template");

    if (container && addBtn && template) {

        const prefix = "{{ formset.prefix }}";
        const totalForms = document.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`);
        let index = parseInt(totalForms.value, 10);

        addBtn.addEventListener("click", function () {
            const clone = document.importNode(template.content, true);

            clone.querySelectorAll("[name],[id],[for]").forEach(el => {
                ["name", "id", "for"].forEach(attr => {
                    if (el.hasAttribute(attr)) {
                        el.setAttribute(
                            attr,
                            el.getAttribute(attr).replace(/__prefix__/g, index)
                        );
                    }
                });
            });

            container.appendChild(clone);
            initSelect2(container.lastElementChild);

            totalForms.value = index + 1;
            index += 1;
        });
    }

    // =====================================================
    // LOCATION ‚Üí WORKSTATION
    // =====================================================
    const $location = $("#id_location");
    const $workstation = $("#id_workstation");

    if ($location.length && $workstation.length) {

        $location.select2({width: "100%"});
        $workstation.select2({
            width: "100%",
            allowClear: true,
            placeholder: "–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
        });

        const WS_URL = "{% url 'maintenance:ajax_workstations_by_location' %}";
        const initialWorkstation = $workstation.val();

        function lockWorkstations(clear = true) {
            if (clear) {
                $workstation.val(null).trigger("change");
            }
            $workstation.prop("disabled", true);
        }

        function unlockWorkstations() {
            $workstation.prop("disabled", false);
        }

        function loadWorkstations(locationId, restoreValue = null) {
            lockWorkstations(true);
            if (!locationId) return;

            fetch(`${WS_URL}?location_id=${locationId}`, {
                headers: {"X-Requested-With": "XMLHttpRequest"}
            })
            .then(r => r.json())
            .then(data => {
                if (!data.ok || !data.items.length) {
                    lockWorkstations(true);
                    return;
                }

                $workstation.empty().append(new Option("", "", false, false));

                data.items.forEach(item => {
                    const selected = restoreValue && item.id == restoreValue;
                    $workstation.append(
                        new Option(item.text, item.id, selected, selected)
                    );
                });

                unlockWorkstations();
                $workstation.trigger("change");
            })
            .catch(() => lockWorkstations(true));
        }

        $location.on("change", function () {
            loadWorkstations(this.value, null);
        });

        if ($location.val()) {
            loadWorkstations($location.val(), initialWorkstation);
        } else {
            lockWorkstations(true);
        }
    }

});
</script>

{% endblock %}

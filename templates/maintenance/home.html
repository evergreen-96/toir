{% extends "base.html" %}
{% block title %}Дашборд{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-0">Дашборд ТОиР</h1>
    <div class="text-muted small">
      Оперативная картина на сегодня
    </div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'maintenance:plan_list' %}">
      Планы
    </a>
    <a class="btn btn-sm btn-primary" href="{% url 'maintenance:wo_list' %}">
      Заявки
    </a>
  </div>
</div>

{# ===================== KPI (compact) ===================== #}
<div class="row g-2 mb-4">

  <div class="col-6 col-md-3">
    <div class="card shadow-sm">
      <div class="card-body py-2">
        <div class="text-muted small">Новые</div>
        <div class="fs-3 fw-semibold">
          {{ stats.new }}
          {% if stats.delta_new %}
            <span class="small ms-1 {% if stats.delta_new > 0 %}text-success{% else %}text-danger{% endif %}">
              {{ stats.delta_new }}
            </span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3">
    <div class="card shadow-sm">
      <div class="card-body py-2">
        <div class="text-muted small">В работе</div>
        <div class="fs-3 fw-semibold">
          {{ stats.in_progress }}
        </div>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3">
    <div class="card shadow-sm">
      <div class="card-body py-2">
        <div class="text-muted small">Выполнено</div>
        <div class="fs-3 fw-semibold">
          {{ stats.done }}
          {% if stats.delta_done %}
            <span class="small ms-1 {% if stats.delta_done > 0 %}text-success{% else %}text-danger{% endif %}">
              {{ stats.delta_done }}
            </span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3">
    <div class="card shadow-sm">
      <div class="card-body py-2">
        <div class="text-muted small">Не выполнено</div>
        <div class="fs-3 fw-semibold">
          {{ stats.failed }}
        </div>
      </div>
    </div>
  </div>

</div>

{# ===================== MAIN ROW ===================== #}
<div class="row g-3 mb-4">

  {# ---- Availability ---- #}
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-muted small mb-1">Оборудование</div>
        <div class="fw-semibold mb-2">Доступность</div>

        <div class="d-flex align-items-end gap-2 mb-2">
          <div class="fs-2 fw-bold">{{ availability.pct }}%</div>
          <div class="text-muted small mb-1">
            {{ availability.in_prod }} / {{ availability.total }}
          </div>
        </div>

        <div class="progress mb-3" style="height:6px">
          <div class="progress-bar" style="width: {{ availability.pct }}%"></div>
        </div>

        <div class="row text-center g-1">
          <div class="col">
            <div class="small text-muted">PROD</div>
            <div class="fw-semibold">{{ availability.in_prod }}</div>
          </div>
          <div class="col">
            <div class="small text-muted">STOP</div>
            <div class="fw-semibold">{{ availability.not_working }}</div>
          </div>
          <div class="col">
            <div class="small text-muted">Аварии</div>
            <div class="fw-semibold text-danger">{{ availability.emergency }}</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  {# ---- Done today ---- #}
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-muted small mb-1">Заявки</div>
        <div class="fw-semibold mb-3">Выполнено сегодня</div>

        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="text-muted small">Плановые</span>
          <span class="fw-semibold">{{ done_stats.pm }}</span>
        </div>

        <div class="d-flex justify-content-between align-items-center">
          <span class="text-muted small">Аварийные</span>
          <span class="fw-semibold">{{ done_stats.emergency }}</span>
        </div>
      </div>
    </div>
  </div>

  {# ---- Category chart ---- #}
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-muted small mb-1">Сегодня</div>
        <div class="fw-semibold mb-2">По категориям</div>
        <div style="height:140px">
          <canvas id="catChart"></canvas>
        </div>
      </div>
    </div>
  </div>

</div>

{# ===================== TREND ===================== #}
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-semibold">Заявки за 7 дней</div>
    </div>
    <div style="height:160px">
      <canvas id="trendChart"></canvas>
    </div>
  </div>
</div>

{# ===================== UPCOMING ===================== #}
<div class="card shadow-sm">
  <div class="card-body p-0">
    <table class="table table-sm table-hover align-middle mb-0">
      <thead class="table-light small">
        <tr>
          <th>Название</th>
          <th>Оборудование</th>
          <th>Локация</th>
          <th>Запуск</th>
        </tr>
      </thead>
      <tbody>
      {% for p in upcoming %}
        <tr>
          <td class="fw-semibold">{{ p.name }}</td>
          <td>{{ p.workstation }}</td>
          <td>{{ p.location }}</td>
          <td>{{ p.next_run|date:"d.m H:i" }}</td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="4" class="text-muted text-center p-3">
            Нет ближайших планов
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
(() => {

  new Chart(document.getElementById('catChart'), {
    type: 'doughnut',
    data: {
      labels: [{% for r in orders_by_category %}"{{ r.category }}",{% endfor %}],
      datasets: [{
        data: [{% for r in orders_by_category %}{{ r.cnt }},{% endfor %}],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: 10 } }
      }
    }
  });

  new Chart(document.getElementById('trendChart'), {
    type: 'bar',
    data: {
      labels: [{% for r in orders_7d %}"{{ r.day|date:'d.m' }}",{% endfor %}],
      datasets: [{
        data: [{% for r in orders_7d %}{{ r.cnt }},{% endfor %}]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true, ticks: { precision: 0 } }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });

})();
</script>

{% endblock %}
